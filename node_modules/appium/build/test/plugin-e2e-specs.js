"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _webdriverio = require("webdriverio");

var _axios = _interopRequireDefault(require("axios"));

var _main = require("../lib/main");

var _extensionConfig = require("../lib/extension-config");

var _helpers = require("./helpers");

var _extension = require("../lib/cli/extension");

const FAKE_ARGS = {
  sillyWebServerPort: 1234,
  host: 'hey'
};
const FAKE_PLUGIN_ARGS = {
  fake: FAKE_ARGS
};
const wdOpts = {
  hostname: _helpers.TEST_HOST,
  port: null,
  connectionRetryCount: 0,
  capabilities: _helpers.W3C_PREFIXED_CAPS
};
describe('FakePlugin', function () {
  const fakePluginDir = _path.default.join(_helpers.PROJECT_ROOT, 'node_modules', '@appium', 'fake-plugin');

  const fakeDriverDir = _path.default.join(_helpers.PROJECT_ROOT, 'packages', 'fake-driver');

  const appiumHome = _extensionConfig.DEFAULT_APPIUM_HOME;
  let baseArgs;
  let testServer;
  let testPort;
  let baseUrl;
  before(async function () {
    wdOpts.port = testPort = await (0, _helpers.getTestPort)();
    testServer = `http://${_helpers.TEST_HOST}:${testPort}`;
    baseUrl = `${testServer}/session`;
    const driverList = await (0, _extension.runExtensionCommand)({
      appiumHome,
      driverCommand: 'list',
      showInstalled: true
    }, _extensionConfig.DRIVER_TYPE);

    if (!_lodash.default.has(driverList, 'fake')) {
      await (0, _extension.runExtensionCommand)({
        appiumHome,
        driverCommand: 'install',
        driver: fakeDriverDir,
        installType: _extensionConfig.INSTALL_TYPE_LOCAL
      }, _extensionConfig.DRIVER_TYPE);
    }

    const pluginList = await (0, _extension.runExtensionCommand)({
      appiumHome,
      pluginCommand: 'list',
      showInstalled: true
    }, _extensionConfig.PLUGIN_TYPE);

    if (!_lodash.default.has(pluginList, 'fake')) {
      await (0, _extension.runExtensionCommand)({
        appiumHome,
        pluginCommand: 'install',
        plugin: fakePluginDir,
        installType: _extensionConfig.INSTALL_TYPE_LOCAL
      }, _extensionConfig.PLUGIN_TYPE);
    }

    baseArgs = {
      port: testPort,
      host: _helpers.TEST_HOST,
      appiumHome,
      usePlugins: ['fake'],
      useDrivers: ['fake']
    };
  });
  describe('without plugin registered', function () {
    let server = null;
    before(async function () {
      const args = {
        port: testPort,
        host: _helpers.TEST_HOST,
        appiumHome,
        usePlugins: ['other1', 'other2']
      };
      server = await (0, _main.main)(args);
    });
    after(async function () {
      if (server) {
        await server.close();
      }
    });
    it('should not update the server if plugin is not activated', async function () {
      await _axios.default.post(`http://${_helpers.TEST_HOST}:${testPort}/fake`).should.eventually.be.rejectedWith(/404/);
    });
    it('should not update method map if plugin is not activated', async function () {
      const driver = await (0, _webdriverio.remote)(wdOpts);
      const {
        sessionId
      } = driver;

      try {
        await _axios.default.post(`${baseUrl}/${sessionId}/fake_data`, {
          data: {
            fake: 'data'
          }
        }).should.eventually.be.rejectedWith(/404/);
      } finally {
        await driver.deleteSession();
      }
    });
    it('should not handle commands if plugin is not activated', async function () {
      const driver = await (0, _webdriverio.remote)(wdOpts);
      const {
        sessionId
      } = driver;

      try {
        const el = (await _axios.default.post(`${baseUrl}/${sessionId}/element`, {
          using: 'xpath',
          value: '//MockWebView'
        })).data.value;
        el.should.not.have.property('fake');
      } finally {
        await driver.deleteSession();
      }
    });
  });

  for (const registrationType of ['explicit', 'all']) {
    describe(`with plugin registered via type ${registrationType}`, function () {
      let server = null;
      before(async function () {
        const usePlugins = registrationType === 'explicit' ? ['fake', 'p2', 'p3'] : ['all'];
        const args = {
          port: testPort,
          host: _helpers.TEST_HOST,
          appiumHome,
          usePlugins,
          useDrivers: ['fake']
        };
        server = await (0, _main.main)(args);
      });
      after(async function () {
        if (server) {
          await server.close();
        }
      });
      it('should update the server', async function () {
        const res = {
          fake: 'fakeResponse'
        };
        (await _axios.default.post(`http://${_helpers.TEST_HOST}:${testPort}/fake`)).data.should.eql(res);
      });
      it('should modify the method map with new commands', async function () {
        const driver = await (0, _webdriverio.remote)(wdOpts);
        const {
          sessionId
        } = driver;

        try {
          await _axios.default.post(`${baseUrl}/${sessionId}/fake_data`, {
            data: {
              fake: 'data'
            }
          });
          (await _axios.default.get(`${baseUrl}/${sessionId}/fake_data`)).data.value.should.eql({
            fake: 'data'
          });
        } finally {
          await driver.deleteSession();
        }
      });
      it('should handle commands and not call the original', async function () {
        const driver = await (0, _webdriverio.remote)(wdOpts);
        const {
          sessionId
        } = driver;

        try {
          await driver.getPageSource().should.eventually.eql(`<Fake>${JSON.stringify([sessionId])}</Fake>`);
        } finally {
          await driver.deleteSession();
        }
      });
      it('should handle commands and call the original if designed', async function () {
        const driver = await (0, _webdriverio.remote)(wdOpts);
        const {
          sessionId
        } = driver;

        try {
          const el = (await _axios.default.post(`${baseUrl}/${sessionId}/element`, {
            using: 'xpath',
            value: '//MockWebView'
          })).data.value;
          el.should.have.property('fake');
        } finally {
          await driver.deleteSession();
        }
      });
      it('should allow original command to be proxied if supported', async function () {
        const driver = await (0, _webdriverio.remote)(wdOpts);
        const {
          sessionId
        } = driver;

        try {
          await _axios.default.post(`${baseUrl}/${sessionId}/context`, {
            name: 'PROXY'
          });
          const handle = (await _axios.default.get(`${baseUrl}/${sessionId}/window/handle`)).data.value;
          handle.should.eql('<<proxied via proxyCommand>>');
        } finally {
          await _axios.default.post(`${baseUrl}/${sessionId}/context`, {
            name: 'NATIVE_APP'
          });
          await driver.deleteSession();
        }
      });
      it('should handle unexpected driver shutdown', async function () {
        const newOpts = { ...wdOpts
        };
        newOpts.capabilities['appium:newCommandTimeout'] = 1;
        const driver = await (0, _webdriverio.remote)(wdOpts);
        let shutdownErr;

        try {
          let res = await _axios.default.get(`http://${_helpers.TEST_HOST}:${testPort}/unexpected`);
          should.not.exist(res.data);
          await _bluebird.default.delay(1500);
          res = await _axios.default.get(`http://${_helpers.TEST_HOST}:${testPort}/unexpected`);
          res.data.should.match(/Session ended/);
          res.data.should.match(/timeout/);
          await driver.deleteSession();
        } catch (e) {
          shutdownErr = e;
        }

        shutdownErr.message.should.match(/either terminated or not started/);
      });
    });
  }

  describe('cli args handling for plugin args', function () {
    let server = null;
    before(async function () {
      const args = { ...baseArgs,
        plugin: FAKE_PLUGIN_ARGS
      };
      server = await (0, _main.main)(args);
    });
    after(async function () {
      if (server) {
        await server.close();
      }
    });
    it('should receive user cli args for plugin if passed in', async function () {
      const driver = await (0, _webdriverio.remote)(wdOpts);
      const {
        sessionId
      } = driver;

      try {
        const {
          data
        } = await _axios.default.get(`${baseUrl}/${sessionId}/fakepluginargs`);
        data.value.should.eql(FAKE_ARGS);
      } finally {
        await driver.deleteSession();
      }
    });
  });
  describe('cli args handling for empty plugin args', function () {
    let server = null;
    before(async function () {
      server = await (0, _main.main)(baseArgs);
    });
    after(async function () {
      if (server) {
        await server.close();
      }
    });
    it('should not receive user cli args for plugin if none were passed in', async function () {
      const driver = await (0, _webdriverio.remote)(wdOpts);
      const {
        sessionId
      } = driver;

      try {
        const {
          data
        } = await _axios.default.get(`${baseUrl}/${sessionId}/fakepluginargs`);
        should.not.exist(data.value);
      } finally {
        await driver.deleteSession();
      }
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvcGx1Z2luLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6WyJGQUtFX0FSR1MiLCJzaWxseVdlYlNlcnZlclBvcnQiLCJob3N0IiwiRkFLRV9QTFVHSU5fQVJHUyIsImZha2UiLCJ3ZE9wdHMiLCJob3N0bmFtZSIsIlRFU1RfSE9TVCIsInBvcnQiLCJjb25uZWN0aW9uUmV0cnlDb3VudCIsImNhcGFiaWxpdGllcyIsIlczQ19QUkVGSVhFRF9DQVBTIiwiZGVzY3JpYmUiLCJmYWtlUGx1Z2luRGlyIiwicGF0aCIsImpvaW4iLCJQUk9KRUNUX1JPT1QiLCJmYWtlRHJpdmVyRGlyIiwiYXBwaXVtSG9tZSIsIkRFRkFVTFRfQVBQSVVNX0hPTUUiLCJiYXNlQXJncyIsInRlc3RTZXJ2ZXIiLCJ0ZXN0UG9ydCIsImJhc2VVcmwiLCJiZWZvcmUiLCJkcml2ZXJMaXN0IiwiZHJpdmVyQ29tbWFuZCIsInNob3dJbnN0YWxsZWQiLCJEUklWRVJfVFlQRSIsIl8iLCJoYXMiLCJkcml2ZXIiLCJpbnN0YWxsVHlwZSIsIklOU1RBTExfVFlQRV9MT0NBTCIsInBsdWdpbkxpc3QiLCJwbHVnaW5Db21tYW5kIiwiUExVR0lOX1RZUEUiLCJwbHVnaW4iLCJ1c2VQbHVnaW5zIiwidXNlRHJpdmVycyIsInNlcnZlciIsImFyZ3MiLCJhZnRlciIsImNsb3NlIiwiaXQiLCJheGlvcyIsInBvc3QiLCJzaG91bGQiLCJldmVudHVhbGx5IiwiYmUiLCJyZWplY3RlZFdpdGgiLCJzZXNzaW9uSWQiLCJkYXRhIiwiZGVsZXRlU2Vzc2lvbiIsImVsIiwidXNpbmciLCJ2YWx1ZSIsIm5vdCIsImhhdmUiLCJwcm9wZXJ0eSIsInJlZ2lzdHJhdGlvblR5cGUiLCJyZXMiLCJlcWwiLCJnZXQiLCJnZXRQYWdlU291cmNlIiwiSlNPTiIsInN0cmluZ2lmeSIsIm5hbWUiLCJoYW5kbGUiLCJuZXdPcHRzIiwic2h1dGRvd25FcnIiLCJleGlzdCIsIkIiLCJkZWxheSIsIm1hdGNoIiwiZSIsIm1lc3Nh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QUNGLEtBVEMsQ0FBRjtBQVVELEdBdEJPLENBQVI7QUF1QkQsQ0FuTk8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgcmVtb3RlIGFzIHdkaW8gfSBmcm9tICd3ZWJkcml2ZXJpbyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgbWFpbiBhcyBhcHBpdW1TZXJ2ZXIgfSBmcm9tICcuLi9saWIvbWFpbic7XG5pbXBvcnQgeyBERUZBVUxUX0FQUElVTV9IT01FLCBJTlNUQUxMX1RZUEVfTE9DQUwsIERSSVZFUl9UWVBFLCBQTFVHSU5fVFlQRSB9IGZyb20gJy4uL2xpYi9leHRlbnNpb24tY29uZmlnJztcbmltcG9ydCB7IFczQ19QUkVGSVhFRF9DQVBTLCBURVNUX0hPU1QsIGdldFRlc3RQb3J0LCBQUk9KRUNUX1JPT1QgfSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IHsgcnVuRXh0ZW5zaW9uQ29tbWFuZCB9IGZyb20gJy4uL2xpYi9jbGkvZXh0ZW5zaW9uJztcblxuXG5jb25zdCBGQUtFX0FSR1MgPSB7c2lsbHlXZWJTZXJ2ZXJQb3J0OiAxMjM0LCBob3N0OiAnaGV5J307XG5jb25zdCBGQUtFX1BMVUdJTl9BUkdTID0ge2Zha2U6IEZBS0VfQVJHU307XG5cbmNvbnN0IHdkT3B0cyA9IHtcbiAgaG9zdG5hbWU6IFRFU1RfSE9TVCxcbiAgcG9ydDogbnVsbCxcbiAgY29ubmVjdGlvblJldHJ5Q291bnQ6IDAsXG4gIGNhcGFiaWxpdGllczogVzNDX1BSRUZJWEVEX0NBUFMsXG59O1xuXG5kZXNjcmliZSgnRmFrZVBsdWdpbicsIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgZmFrZVBsdWdpbkRpciA9IHBhdGguam9pbihQUk9KRUNUX1JPT1QsICdub2RlX21vZHVsZXMnLCAnQGFwcGl1bScsICdmYWtlLXBsdWdpbicpO1xuICBjb25zdCBmYWtlRHJpdmVyRGlyID0gcGF0aC5qb2luKFBST0pFQ1RfUk9PVCwgJ3BhY2thZ2VzJywgJ2Zha2UtZHJpdmVyJyk7XG4gIGNvbnN0IGFwcGl1bUhvbWUgPSBERUZBVUxUX0FQUElVTV9IT01FO1xuICBsZXQgYmFzZUFyZ3M7XG4gIGxldCB0ZXN0U2VydmVyO1xuICBsZXQgdGVzdFBvcnQ7XG4gIGxldCBiYXNlVXJsO1xuXG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgd2RPcHRzLnBvcnQgPSB0ZXN0UG9ydCA9IGF3YWl0IGdldFRlc3RQb3J0KCk7XG4gICAgdGVzdFNlcnZlciA9IGBodHRwOi8vJHtURVNUX0hPU1R9OiR7dGVzdFBvcnR9YDtcbiAgICBiYXNlVXJsID0gYCR7dGVzdFNlcnZlcn0vc2Vzc2lvbmA7XG4gICAgLy8gZmlyc3QgZW5zdXJlIHdlIGhhdmUgZmFrZWRyaXZlciBpbnN0YWxsZWRcbiAgICBjb25zdCBkcml2ZXJMaXN0ID0gYXdhaXQgcnVuRXh0ZW5zaW9uQ29tbWFuZCh7XG4gICAgICBhcHBpdW1Ib21lLFxuICAgICAgZHJpdmVyQ29tbWFuZDogJ2xpc3QnLFxuICAgICAgc2hvd0luc3RhbGxlZDogdHJ1ZSxcbiAgICB9LCBEUklWRVJfVFlQRSk7XG4gICAgaWYgKCFfLmhhcyhkcml2ZXJMaXN0LCAnZmFrZScpKSB7XG4gICAgICBhd2FpdCBydW5FeHRlbnNpb25Db21tYW5kKHtcbiAgICAgICAgYXBwaXVtSG9tZSxcbiAgICAgICAgZHJpdmVyQ29tbWFuZDogJ2luc3RhbGwnLFxuICAgICAgICBkcml2ZXI6IGZha2VEcml2ZXJEaXIsXG4gICAgICAgIGluc3RhbGxUeXBlOiBJTlNUQUxMX1RZUEVfTE9DQUwsXG4gICAgICB9LCBEUklWRVJfVFlQRSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGx1Z2luTGlzdCA9IGF3YWl0IHJ1bkV4dGVuc2lvbkNvbW1hbmQoe1xuICAgICAgYXBwaXVtSG9tZSxcbiAgICAgIHBsdWdpbkNvbW1hbmQ6ICdsaXN0JyxcbiAgICAgIHNob3dJbnN0YWxsZWQ6IHRydWUsXG4gICAgfSwgUExVR0lOX1RZUEUpO1xuICAgIGlmICghXy5oYXMocGx1Z2luTGlzdCwgJ2Zha2UnKSkge1xuICAgICAgYXdhaXQgcnVuRXh0ZW5zaW9uQ29tbWFuZCh7XG4gICAgICAgIGFwcGl1bUhvbWUsXG4gICAgICAgIHBsdWdpbkNvbW1hbmQ6ICdpbnN0YWxsJyxcbiAgICAgICAgcGx1Z2luOiBmYWtlUGx1Z2luRGlyLFxuICAgICAgICBpbnN0YWxsVHlwZTogSU5TVEFMTF9UWVBFX0xPQ0FMLFxuICAgICAgfSwgUExVR0lOX1RZUEUpO1xuICAgIH1cbiAgICBiYXNlQXJncyA9IHtwb3J0OiB0ZXN0UG9ydCwgaG9zdDogVEVTVF9IT1NULCBhcHBpdW1Ib21lLCB1c2VQbHVnaW5zOiBbJ2Zha2UnXSwgdXNlRHJpdmVyczogWydmYWtlJ119O1xuICB9KTtcblxuICBkZXNjcmliZSgnd2l0aG91dCBwbHVnaW4gcmVnaXN0ZXJlZCcsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2VydmVyID0gbnVsbDtcbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgLy8gdGhlbiBzdGFydCBzZXJ2ZXIgaWYgd2UgbmVlZCB0b1xuICAgICAgY29uc3QgYXJncyA9IHtwb3J0OiB0ZXN0UG9ydCwgaG9zdDogVEVTVF9IT1NULCBhcHBpdW1Ib21lLCB1c2VQbHVnaW5zOiBbJ290aGVyMScsICdvdGhlcjInXX07XG4gICAgICBzZXJ2ZXIgPSBhd2FpdCBhcHBpdW1TZXJ2ZXIoYXJncyk7XG4gICAgfSk7XG4gICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHNlcnZlcikge1xuICAgICAgICBhd2FpdCBzZXJ2ZXIuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIG5vdCB1cGRhdGUgdGhlIHNlcnZlciBpZiBwbHVnaW4gaXMgbm90IGFjdGl2YXRlZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGF4aW9zLnBvc3QoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHt0ZXN0UG9ydH0vZmFrZWApLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvNDA0Lyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3QgdXBkYXRlIG1ldGhvZCBtYXAgaWYgcGx1Z2luIGlzIG5vdCBhY3RpdmF0ZWQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBkcml2ZXIgPSBhd2FpdCB3ZGlvKHdkT3B0cyk7XG4gICAgICBjb25zdCB7c2Vzc2lvbklkfSA9IGRyaXZlcjtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGF4aW9zLnBvc3QoYCR7YmFzZVVybH0vJHtzZXNzaW9uSWR9L2Zha2VfZGF0YWAsIHtkYXRhOiB7ZmFrZTogJ2RhdGEnfX0pLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvNDA0Lyk7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBhd2FpdCBkcml2ZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgbm90IGhhbmRsZSBjb21tYW5kcyBpZiBwbHVnaW4gaXMgbm90IGFjdGl2YXRlZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IGRyaXZlciA9IGF3YWl0IHdkaW8od2RPcHRzKTtcbiAgICAgIGNvbnN0IHtzZXNzaW9uSWR9ID0gZHJpdmVyO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZWwgPSAoYXdhaXQgYXhpb3MucG9zdChgJHtiYXNlVXJsfS8ke3Nlc3Npb25JZH0vZWxlbWVudGAsIHt1c2luZzogJ3hwYXRoJywgdmFsdWU6ICcvL01vY2tXZWJWaWV3J30pKS5kYXRhLnZhbHVlO1xuICAgICAgICBlbC5zaG91bGQubm90LmhhdmUucHJvcGVydHkoJ2Zha2UnKTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IGRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIGZvciAoY29uc3QgcmVnaXN0cmF0aW9uVHlwZSBvZiBbJ2V4cGxpY2l0JywgJ2FsbCddKSB7XG4gICAgZGVzY3JpYmUoYHdpdGggcGx1Z2luIHJlZ2lzdGVyZWQgdmlhIHR5cGUgJHtyZWdpc3RyYXRpb25UeXBlfWAsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzZXJ2ZXIgPSBudWxsO1xuICAgICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgLy8gdGhlbiBzdGFydCBzZXJ2ZXIgaWYgd2UgbmVlZCB0b1xuICAgICAgICBjb25zdCB1c2VQbHVnaW5zID0gcmVnaXN0cmF0aW9uVHlwZSA9PT0gJ2V4cGxpY2l0JyA/IFsnZmFrZScsICdwMicsICdwMyddIDogWydhbGwnXTtcbiAgICAgICAgY29uc3QgYXJncyA9IHtwb3J0OiB0ZXN0UG9ydCwgaG9zdDogVEVTVF9IT1NULCBhcHBpdW1Ib21lLCB1c2VQbHVnaW5zLCB1c2VEcml2ZXJzOiBbJ2Zha2UnXX07XG4gICAgICAgIHNlcnZlciA9IGF3YWl0IGFwcGl1bVNlcnZlcihhcmdzKTtcbiAgICAgIH0pO1xuICAgICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoc2VydmVyKSB7XG4gICAgICAgICAgYXdhaXQgc2VydmVyLmNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIHNlcnZlcicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgcmVzID0ge2Zha2U6ICdmYWtlUmVzcG9uc2UnfTtcbiAgICAgICAgKGF3YWl0IGF4aW9zLnBvc3QoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHt0ZXN0UG9ydH0vZmFrZWApKS5kYXRhLnNob3VsZC5lcWwocmVzKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIG1vZGlmeSB0aGUgbWV0aG9kIG1hcCB3aXRoIG5ldyBjb21tYW5kcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgZHJpdmVyID0gYXdhaXQgd2Rpbyh3ZE9wdHMpO1xuICAgICAgICBjb25zdCB7c2Vzc2lvbklkfSA9IGRyaXZlcjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBheGlvcy5wb3N0KGAke2Jhc2VVcmx9LyR7c2Vzc2lvbklkfS9mYWtlX2RhdGFgLCB7ZGF0YToge2Zha2U6ICdkYXRhJ319KTtcbiAgICAgICAgICAoYXdhaXQgYXhpb3MuZ2V0KGAke2Jhc2VVcmx9LyR7c2Vzc2lvbklkfS9mYWtlX2RhdGFgKSkuZGF0YS52YWx1ZS5zaG91bGQuZXFsKHtmYWtlOiAnZGF0YSd9KTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBhd2FpdCBkcml2ZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgY29tbWFuZHMgYW5kIG5vdCBjYWxsIHRoZSBvcmlnaW5hbCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgZHJpdmVyID0gYXdhaXQgd2Rpbyh3ZE9wdHMpO1xuICAgICAgICBjb25zdCB7c2Vzc2lvbklkfSA9IGRyaXZlcjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBkcml2ZXIuZ2V0UGFnZVNvdXJjZSgpLnNob3VsZC5ldmVudHVhbGx5LmVxbChgPEZha2U+JHtKU09OLnN0cmluZ2lmeShbc2Vzc2lvbklkXSl9PC9GYWtlPmApO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgIGF3YWl0IGRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSBjb21tYW5kcyBhbmQgY2FsbCB0aGUgb3JpZ2luYWwgaWYgZGVzaWduZWQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IGRyaXZlciA9IGF3YWl0IHdkaW8od2RPcHRzKTtcbiAgICAgICAgY29uc3Qge3Nlc3Npb25JZH0gPSBkcml2ZXI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgZWwgPSAoYXdhaXQgYXhpb3MucG9zdChgJHtiYXNlVXJsfS8ke3Nlc3Npb25JZH0vZWxlbWVudGAsIHt1c2luZzogJ3hwYXRoJywgdmFsdWU6ICcvL01vY2tXZWJWaWV3J30pKS5kYXRhLnZhbHVlO1xuICAgICAgICAgIGVsLnNob3VsZC5oYXZlLnByb3BlcnR5KCdmYWtlJyk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgYXdhaXQgZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgYWxsb3cgb3JpZ2luYWwgY29tbWFuZCB0byBiZSBwcm94aWVkIGlmIHN1cHBvcnRlZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgZHJpdmVyID0gYXdhaXQgd2Rpbyh3ZE9wdHMpO1xuICAgICAgICBjb25zdCB7c2Vzc2lvbklkfSA9IGRyaXZlcjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBheGlvcy5wb3N0KGAke2Jhc2VVcmx9LyR7c2Vzc2lvbklkfS9jb250ZXh0YCwge25hbWU6ICdQUk9YWSd9KTtcbiAgICAgICAgICBjb25zdCBoYW5kbGUgPSAoYXdhaXQgYXhpb3MuZ2V0KGAke2Jhc2VVcmx9LyR7c2Vzc2lvbklkfS93aW5kb3cvaGFuZGxlYCkpLmRhdGEudmFsdWU7XG4gICAgICAgICAgaGFuZGxlLnNob3VsZC5lcWwoJzw8cHJveGllZCB2aWEgcHJveHlDb21tYW5kPj4nKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBhd2FpdCBheGlvcy5wb3N0KGAke2Jhc2VVcmx9LyR7c2Vzc2lvbklkfS9jb250ZXh0YCwge25hbWU6ICdOQVRJVkVfQVBQJ30pO1xuICAgICAgICAgIGF3YWl0IGRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSB1bmV4cGVjdGVkIGRyaXZlciBzaHV0ZG93bicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgbmV3T3B0cyA9IHsuLi53ZE9wdHN9O1xuICAgICAgICBuZXdPcHRzLmNhcGFiaWxpdGllc1snYXBwaXVtOm5ld0NvbW1hbmRUaW1lb3V0J10gPSAxO1xuICAgICAgICBjb25zdCBkcml2ZXIgPSBhd2FpdCB3ZGlvKHdkT3B0cyk7XG4gICAgICAgIGxldCBzaHV0ZG93bkVycjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgYXhpb3MuZ2V0KGBodHRwOi8vJHtURVNUX0hPU1R9OiR7dGVzdFBvcnR9L3VuZXhwZWN0ZWRgKTtcbiAgICAgICAgICBzaG91bGQubm90LmV4aXN0KHJlcy5kYXRhKTtcbiAgICAgICAgICBhd2FpdCBCLmRlbGF5KDE1MDApO1xuICAgICAgICAgIHJlcyA9IGF3YWl0IGF4aW9zLmdldChgaHR0cDovLyR7VEVTVF9IT1NUfToke3Rlc3RQb3J0fS91bmV4cGVjdGVkYCk7XG4gICAgICAgICAgcmVzLmRhdGEuc2hvdWxkLm1hdGNoKC9TZXNzaW9uIGVuZGVkLyk7XG4gICAgICAgICAgcmVzLmRhdGEuc2hvdWxkLm1hdGNoKC90aW1lb3V0Lyk7XG4gICAgICAgICAgYXdhaXQgZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHNodXRkb3duRXJyID0gZTtcbiAgICAgICAgfVxuICAgICAgICBzaHV0ZG93bkVyci5tZXNzYWdlLnNob3VsZC5tYXRjaCgvZWl0aGVyIHRlcm1pbmF0ZWQgb3Igbm90IHN0YXJ0ZWQvKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGRlc2NyaWJlKCdjbGkgYXJncyBoYW5kbGluZyBmb3IgcGx1Z2luIGFyZ3MnLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNlcnZlciA9IG51bGw7XG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIHRoZW4gc3RhcnQgc2VydmVyIGlmIHdlIG5lZWQgdG9cbiAgICAgIGNvbnN0IGFyZ3MgPSB7Li4uYmFzZUFyZ3MsIHBsdWdpbjogRkFLRV9QTFVHSU5fQVJHU307XG4gICAgICBzZXJ2ZXIgPSBhd2FpdCBhcHBpdW1TZXJ2ZXIoYXJncyk7XG4gICAgfSk7XG4gICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHNlcnZlcikge1xuICAgICAgICBhd2FpdCBzZXJ2ZXIuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVjZWl2ZSB1c2VyIGNsaSBhcmdzIGZvciBwbHVnaW4gaWYgcGFzc2VkIGluJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgZHJpdmVyID0gYXdhaXQgd2Rpbyh3ZE9wdHMpO1xuICAgICAgY29uc3Qge3Nlc3Npb25JZH0gPSBkcml2ZXI7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7ZGF0YX0gPSBhd2FpdCBheGlvcy5nZXQoYCR7YmFzZVVybH0vJHtzZXNzaW9uSWR9L2Zha2VwbHVnaW5hcmdzYCk7XG4gICAgICAgIGRhdGEudmFsdWUuc2hvdWxkLmVxbChGQUtFX0FSR1MpO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgYXdhaXQgZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKCdjbGkgYXJncyBoYW5kbGluZyBmb3IgZW1wdHkgcGx1Z2luIGFyZ3MnLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNlcnZlciA9IG51bGw7XG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIHRoZW4gc3RhcnQgc2VydmVyIGlmIHdlIG5lZWQgdG9cbiAgICAgIHNlcnZlciA9IGF3YWl0IGFwcGl1bVNlcnZlcihiYXNlQXJncyk7XG4gICAgfSk7XG4gICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHNlcnZlcikge1xuICAgICAgICBhd2FpdCBzZXJ2ZXIuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IHJlY2VpdmUgdXNlciBjbGkgYXJncyBmb3IgcGx1Z2luIGlmIG5vbmUgd2VyZSBwYXNzZWQgaW4nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBkcml2ZXIgPSBhd2FpdCB3ZGlvKHdkT3B0cyk7XG4gICAgICBjb25zdCB7c2Vzc2lvbklkfSA9IGRyaXZlcjtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHtkYXRhfSA9IGF3YWl0IGF4aW9zLmdldChgJHtiYXNlVXJsfS8ke3Nlc3Npb25JZH0vZmFrZXBsdWdpbmFyZ3NgKTtcbiAgICAgICAgc2hvdWxkLm5vdC5leGlzdChkYXRhLnZhbHVlKTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IGRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwiZmlsZSI6InRlc3QvcGx1Z2luLWUyZS1zcGVjcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
