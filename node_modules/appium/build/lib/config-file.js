"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.formatErrors = formatErrors;
exports.normalizeConfig = normalizeConfig;
exports.readConfigFile = readConfigFile;

require("source-map-support/register");

var _betterAjvErrors = _interopRequireDefault(require("@sidvind/better-ajv-errors"));

var _lilconfig = require("lilconfig");

var _lodash = _interopRequireDefault(require("lodash"));

var _yaml = _interopRequireDefault(require("yaml"));

var _schema = require("./schema/schema");

function yamlLoader(filepath, content) {
  return _yaml.default.parse(content);
}

const rawConfig = new Map();

function jsonLoader(filepath, content) {
  rawConfig.set(filepath, content);
  return JSON.parse(content);
}

async function loadConfigFile(lc, filepath) {
  try {
    return await lc.load(filepath);
  } catch (err) {
    if (err.code === 'ENOENT') {
      err.message = `Config file not found at user-provided path: ${filepath}`;
      throw err;
    } else if (err instanceof SyntaxError) {
      err.message = `Config file at user-provided path ${filepath} is invalid:\n${err.message}`;
      throw err;
    }

    throw err;
  }
}

async function searchConfigFile(lc) {
  return await lc.search();
}

function formatErrors(errors = [], config = {}, opts = {}) {
  if (errors && !errors.length) {
    throw new TypeError('Array of errors must be non-empty');
  }

  return (0, _betterAjvErrors.default)((0, _schema.getSchema)(opts.schemaId), config, errors, {
    json: opts.json,
    format: 'cli'
  });
}

async function readConfigFile(filepath, opts = {}) {
  const lc = (0, _lilconfig.lilconfig)('appium', {
    loaders: {
      '.yaml': yamlLoader,
      '.yml': yamlLoader,
      '.json': jsonLoader,
      noExt: jsonLoader
    },
    packageProp: 'appiumConfig'
  });
  const result = filepath ? await loadConfigFile(lc, filepath) : await searchConfigFile(lc);

  if (result !== null && result !== void 0 && result.filepath && !(result !== null && result !== void 0 && result.isEmpty)) {
    const {
      pretty = true
    } = opts;

    try {
      let configResult;
      const errors = (0, _schema.validate)(result.config);

      if (_lodash.default.isEmpty(errors)) {
        configResult = { ...result,
          errors
        };
      } else {
        const reason = formatErrors(errors, result.config, {
          json: rawConfig.get(result.filepath),
          pretty
        });
        configResult = reason ? { ...result,
          errors,
          reason
        } : { ...result,
          errors
        };
      }

      configResult.config = normalizeConfig(configResult.config);
      return configResult;
    } finally {
      rawConfig.delete(result.filepath);
    }
  }

  return result !== null && result !== void 0 ? result : {};
}

function normalizeConfig(config) {
  const schema = (0, _schema.getSchema)();

  const normalize = (config, section) => {
    const obj = _lodash.default.isUndefined(section) ? config : _lodash.default.get(config, section, config);

    const mappedObj = _lodash.default.mapKeys(obj, (__, prop) => {
      var _schema$properties$pr, _schema$properties$pr2;

      return (_schema$properties$pr = (_schema$properties$pr2 = schema.properties[prop]) === null || _schema$properties$pr2 === void 0 ? void 0 : _schema$properties$pr2.appiumCliDest) !== null && _schema$properties$pr !== void 0 ? _schema$properties$pr : _lodash.default.camelCase(prop);
    });

    return _lodash.default.mapValues(mappedObj, (value, property) => {
      const nextSection = section ? `${section}.${property}` : property;
      return isSchemaTypeObject(value) ? normalize(config, nextSection) : value;
    });
  };

  const isSchemaTypeObject = schema => Boolean(schema.properties);

  return normalize(config);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb25maWctZmlsZS5qcyJdLCJuYW1lcyI6WyJ5YW1sTG9hZGVyIiwiZmlsZXBhdGgiLCJjb250ZW50IiwieWFtbCIsInBhcnNlIiwicmF3Q29uZmlnIiwiTWFwIiwianNvbkxvYWRlciIsInNldCIsIkpTT04iLCJsb2FkQ29uZmlnRmlsZSIsImxjIiwibG9hZCIsImVyciIsImNvZGUiLCJtZXNzYWdlIiwiU3ludGF4RXJyb3IiLCJzZWFyY2hDb25maWdGaWxlIiwic2VhcmNoIiwiZm9ybWF0RXJyb3JzIiwiZXJyb3JzIiwiY29uZmlnIiwib3B0cyIsImxlbmd0aCIsIlR5cGVFcnJvciIsInNjaGVtYUlkIiwianNvbiIsImZvcm1hdCIsInJlYWRDb25maWdGaWxlIiwibG9hZGVycyIsIm5vRXh0IiwicGFja2FnZVByb3AiLCJyZXN1bHQiLCJpc0VtcHR5IiwicHJldHR5IiwiY29uZmlnUmVzdWx0IiwiXyIsInJlYXNvbiIsImdldCIsIm5vcm1hbGl6ZUNvbmZpZyIsImRlbGV0ZSIsInNjaGVtYSIsIm5vcm1hbGl6ZSIsInNlY3Rpb24iLCJvYmoiLCJpc1VuZGVmaW5lZCIsIm1hcHBlZE9iaiIsIm1hcEtleXMiLCJfXyIsInByb3AiLCJwcm9wZXJ0aWVzIiwiYXBwaXVtQ2xpRGVzdCIsImNhbWVsQ2FzZSIsIm1hcFZhbHVlcyIsInZhbHVlIiwicHJvcGVydHkiLCJuZXh0U2VjdGlvbiIsImlzU2NoZW1hVHlwZU9iamVjdCIsIkJvb2xlYW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFNQSxTQUFTQSxVQUFULENBQXFCQyxRQUFyQixFQUErQkMsT0FBL0IsRUFBd0M7QUFDdEMsU0FBT0MsY0FBS0MsS0FBTCxDQUFXRixPQUFYLENBQVA7QUFDRDs7QUFRRCxNQUFNRyxTQUFTLEdBQUcsSUFBSUMsR0FBSixFQUFsQjs7QUFPQSxTQUFTQyxVQUFULENBQXFCTixRQUFyQixFQUErQkMsT0FBL0Is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QixTQUFGLENBQVlQLFNBQVosRUFBdUIsQ0FBQ1EsS0FBRCxFQUFRQyxRQUFSLEtBQXFCO0FBQ2pELFlBQU1DLFdBQVcsR0FBR2IsT0FBTyxHQUFJLEdBQUVBLE9BQVEsSUFBR1ksUUFBUyxFQUExQixHQUE4QkEsUUFBekQ7QUFDQSxhQUFPRSxrQkFBa0IsQ0FBQ0gsS0FBRCxDQUFsQixHQUE0QlosU0FBUyxDQUFDckIsTUFBRCxFQUFTbUMsV0FBVCxDQUFyQyxHQUE2REYsS0FBcEU7QUFDRCxLQUhNLENBQVA7QUFJRCxHQVhEOztBQWlCQSxRQUFNRyxrQkFBa0IsR0FBSWhCLE1BQUQsSUFBWWlCLE9BQU8sQ0FBQ2pCLE1BQU0sQ0FBQ1MsVUFBUixDQUE5Qzs7QUFFQSxTQUFPUixTQUFTLENBQUNyQixNQUFELENBQWhCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtY2hlY2tcblxuaW1wb3J0IGJldHRlckFqdkVycm9ycyBmcm9tICdAc2lkdmluZC9iZXR0ZXItYWp2LWVycm9ycyc7XG5pbXBvcnQgeyBsaWxjb25maWcgfSBmcm9tICdsaWxjb25maWcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB5YW1sIGZyb20gJ3lhbWwnO1xuaW1wb3J0IHsgZ2V0U2NoZW1hLCB2YWxpZGF0ZSB9IGZyb20gJy4vc2NoZW1hL3NjaGVtYSc7XG5cbi8qKlxuICogbGlsY29uZmlnIGxvYWRlciB0byBoYW5kbGUgYC55YW1sYCBmaWxlc1xuICogQHR5cGUge2ltcG9ydCgnbGlsY29uZmlnJykuTG9hZGVyU3luY31cbiAqL1xuZnVuY3Rpb24geWFtbExvYWRlciAoZmlsZXBhdGgsIGNvbnRlbnQpIHtcbiAgcmV0dXJuIHlhbWwucGFyc2UoY29udGVudCk7XG59XG5cbi8qKlxuICogQSBjYWNoZSBvZiB0aGUgcmF3IGNvbmZpZyBmaWxlIChhIEpTT04gc3RyaW5nKSBhdCBhIGZpbGVwYXRoLlxuICogVGhpcyBpcyB1c2VkIGZvciBiZXR0ZXIgZXJyb3IgcmVwb3J0aW5nLlxuICogTm90ZSB0aGF0IGNvbmZpZyBmaWxlcyBuZWVkbid0IGJlIEpTT04sIGJ1dCBpdCBoZWxwcyBpZiB0aGV5IGFyZS5cbiAqIEB0eXBlIHtNYXA8c3RyaW5nLFJhd0pzb24+fVxuICovXG5jb25zdCByYXdDb25maWcgPSBuZXcgTWFwKCk7XG5cbi8qKlxuICogQ3VzdG9tIEpTT04gbG9hZGVyIHRoYXQgY2FjaGVzIHRoZSByYXcgY29uZmlnIGZpbGUgKGZvciB1c2Ugd2l0aCBgYmV0dGVyLWFqdi1lcnJvcnNgKS5cbiAqIElmIGl0IHdlcmVuJ3QgZm9yIHRoaXMgY2FjaGUsIHRoaXMgd291bGQgYmUgdW5uZWNlc3NhcnkuXG4gKiBAdHlwZSB7aW1wb3J0KCdsaWxjb25maWcnKS5Mb2FkZXJTeW5jfVxuICovXG5mdW5jdGlvbiBqc29uTG9hZGVyIChmaWxlcGF0aCwgY29udGVudCkge1xuICByYXdDb25maWcuc2V0KGZpbGVwYXRoLCBjb250ZW50KTtcbiAgcmV0dXJuIEpTT04ucGFyc2UoY29udGVudCk7XG59XG5cbi8qKlxuICogTG9hZHMgYSBjb25maWcgZmlsZSBmcm9tIGFuIGV4cGxpY2l0IHBhdGhcbiAqIEBwYXJhbSB7TGlsY29uZmlnQXN5bmNTZWFyY2hlcn0gbGMgLSBsaWxjb25maWcgaW5zdGFuY2VcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlcGF0aCAtIFBhdGggdG8gY29uZmlnIGZpbGVcbiAqIEByZXR1cm5zIHtQcm9taXNlPGltcG9ydCgnbGlsY29uZmlnJykuTGlsY29uZmlnUmVzdWx0Pn1cbiAqL1xuYXN5bmMgZnVuY3Rpb24gbG9hZENvbmZpZ0ZpbGUgKGxjLCBmaWxlcGF0aCkge1xuICB0cnkge1xuICAgIC8vIHJlbW92aW5nIFwiYXdhaXRcIiB3aWxsIGNhdXNlIGFueSByZWplY3Rpb24gdG8gX25vdF8gYmUgY2F1Z2h0IGluIHRoaXMgYmxvY2shXG4gICAgcmV0dXJuIGF3YWl0IGxjLmxvYWQoZmlsZXBhdGgpO1xuICB9IGNhdGNoICgvKiogQHR5cGUge3Vua25vd259ICovZXJyKSB7XG4gICAgaWYgKC8qKiBAdHlwZSB7Tm9kZUpTLkVycm5vRXhjZXB0aW9ufSAqLyhlcnIpLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAvKiogQHR5cGUge05vZGVKUy5FcnJub0V4Y2VwdGlvbn0gKi8oZXJyKS5tZXNzYWdlID0gYENvbmZpZyBmaWxlIG5vdCBmb3VuZCBhdCB1c2VyLXByb3ZpZGVkIHBhdGg6ICR7ZmlsZXBhdGh9YDtcbiAgICAgIHRocm93IGVycjtcbiAgICB9IGVsc2UgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XG4gICAgICAvLyBnZW5lcmFsbHkgaW52YWxpZCBKU09OXG4gICAgICBlcnIubWVzc2FnZSA9IGBDb25maWcgZmlsZSBhdCB1c2VyLXByb3ZpZGVkIHBhdGggJHtmaWxlcGF0aH0gaXMgaW52YWxpZDpcXG4ke2Vyci5tZXNzYWdlfWA7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufVxuXG4vKipcbiAqIFNlYXJjaGVzIGZvciBhIGNvbmZpZyBmaWxlXG4gKiBAcGFyYW0ge0xpbGNvbmZpZ0FzeW5jU2VhcmNoZXJ9IGxjIC0gbGlsY29uZmlnIGluc3RhbmNlXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxpbXBvcnQoJ2xpbGNvbmZpZycpLkxpbGNvbmZpZ1Jlc3VsdD59XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaENvbmZpZ0ZpbGUgKGxjKSB7XG4gIHJldHVybiBhd2FpdCBsYy5zZWFyY2goKTtcbn1cblxuLyoqXG4gKiBHaXZlbiBhbiBhcnJheSBvZiBlcnJvcnMgYW5kIHRoZSByZXN1bHQgb2YgbG9hZGluZyBhIGNvbmZpZyBmaWxlLCBnZW5lcmF0ZSBhXG4gKiBoZWxwZnVsIHN0cmluZyBmb3IgdGhlIHVzZXIuXG4gKlxuICogLSBJZiBgb3B0c2AgY29udGFpbnMgYSBganNvbmAgcHJvcGVydHksIHRoaXMgc2hvdWxkIGJlIHRoZSBvcmlnaW5hbCBKU09OXG4gKiAgIF9zdHJpbmdfIG9mIHRoZSBjb25maWcgZmlsZS4gIFRoaXMgaXMgb25seSBhcHBsaWNhYmxlIGlmIHRoZSBjb25maWcgZmlsZVxuICogICB3YXMgaW4gSlNPTiBmb3JtYXQuIElmIHByZXNlbnQsIGl0IHdpbGwgYXNzb2NpYXRlIGxpbmUgbnVtYmVycyB3aXRoIGVycm9ycy5cbiAqIC0gSWYgYGVycm9yc2AgaGFwcGVucyB0byBiZSBlbXB0eSwgdGhpcyB3aWxsIHRocm93LlxuICogQHBhcmFtIHtpbXBvcnQoJ2FqdicpLkVycm9yT2JqZWN0W119IGVycm9ycyAtIE5vbi1lbXB0eSBhcnJheSBvZiBlcnJvcnMuIFJlcXVpcmVkLlxuICogQHBhcmFtIHtSZWFkQ29uZmlnRmlsZVJlc3VsdFsnY29uZmlnJ118YW55fSBbY29uZmlnXSAtXG4gKiBDb25maWd1cmF0aW9uICYgbWV0YWRhdGFcbiAqIEBwYXJhbSB7Rm9ybWF0Q29uZmlnRXJyb3JzT3B0aW9uc30gW29wdHNdXG4gKiBAdGhyb3dzIHtUeXBlRXJyb3J9IElmIGBlcnJvcnNgIGlzIGVtcHR5XG4gKiBAcmV0dXJucyB7c3RyaW5nfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RXJyb3JzIChlcnJvcnMgPSBbXSwgY29uZmlnID0ge30sIG9wdHMgPSB7fSkge1xuICBpZiAoZXJyb3JzICYmICFlcnJvcnMubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJyYXkgb2YgZXJyb3JzIG11c3QgYmUgbm9uLWVtcHR5Jyk7XG4gIH1cbiAgcmV0dXJuIGJldHRlckFqdkVycm9ycyhnZXRTY2hlbWEob3B0cy5zY2hlbWFJZCksIGNvbmZpZywgZXJyb3JzLCB7XG4gICAganNvbjogb3B0cy5qc29uLFxuICAgIGZvcm1hdDogJ2NsaScsXG4gIH0pO1xufVxuXG4vKipcbiAqIEdpdmVuIGFuIG9wdGlvbmFsIHBhdGgsIHJlYWQgYSBjb25maWcgZmlsZS4gVmFsaWRhdGVzIHRoZSBjb25maWcgZmlsZS5cbiAqXG4gKiBDYWxsIHtAbGluayB2YWxpZGF0ZX0gaWYgeW91IGFscmVhZHkgaGF2ZSBhIGNvbmZpZyBvYmplY3QuXG4gKiBAcGFyYW0ge3N0cmluZ30gW2ZpbGVwYXRoXSAtIFBhdGggdG8gY29uZmlnIGZpbGUsIGlmIHdlIGhhdmUgb25lXG4gKiBAcGFyYW0ge1JlYWRDb25maWdGaWxlT3B0aW9uc30gW29wdHNdIC0gT3B0aW9uc1xuICogQHB1YmxpY1xuICogQHJldHVybnMge1Byb21pc2U8UmVhZENvbmZpZ0ZpbGVSZXN1bHQ+fSBDb250YWlucyBjb25maWcgYW5kIGZpbGVwYXRoLCBpZiBmb3VuZCwgYW5kIGFueSBlcnJvcnNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlYWRDb25maWdGaWxlIChmaWxlcGF0aCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IGxjID0gbGlsY29uZmlnKCdhcHBpdW0nLCB7XG4gICAgbG9hZGVyczoge1xuICAgICAgJy55YW1sJzogeWFtbExvYWRlcixcbiAgICAgICcueW1sJzogeWFtbExvYWRlcixcbiAgICAgICcuanNvbic6IGpzb25Mb2FkZXIsXG4gICAgICBub0V4dDoganNvbkxvYWRlcixcbiAgICB9LFxuICAgIHBhY2thZ2VQcm9wOiAnYXBwaXVtQ29uZmlnJ1xuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBmaWxlcGF0aFxuICAgID8gYXdhaXQgbG9hZENvbmZpZ0ZpbGUobGMsIGZpbGVwYXRoKVxuICAgIDogYXdhaXQgc2VhcmNoQ29uZmlnRmlsZShsYyk7XG5cbiAgaWYgKHJlc3VsdD8uZmlsZXBhdGggJiYgIXJlc3VsdD8uaXNFbXB0eSkge1xuICAgIGNvbnN0IHtwcmV0dHkgPSB0cnVlfSA9IG9wdHM7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBjb25maWdSZXN1bHQ7XG4gICAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0ZShyZXN1bHQuY29uZmlnKTtcbiAgICAgIGlmIChfLmlzRW1wdHkoZXJyb3JzKSkge1xuICAgICAgICBjb25maWdSZXN1bHQgPSB7Li4ucmVzdWx0LCBlcnJvcnN9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVhc29uID0gZm9ybWF0RXJyb3JzKGVycm9ycywgcmVzdWx0LmNvbmZpZywge1xuICAgICAgICAgIGpzb246IHJhd0NvbmZpZy5nZXQocmVzdWx0LmZpbGVwYXRoKSxcbiAgICAgICAgICBwcmV0dHksXG4gICAgICAgIH0pO1xuICAgICAgICBjb25maWdSZXN1bHQgPSByZWFzb25cbiAgICAgICAgICA/IHsuLi5yZXN1bHQsIGVycm9ycywgcmVhc29ufVxuICAgICAgICAgIDogey4uLnJlc3VsdCwgZXJyb3JzfTtcbiAgICAgIH1cblxuICAgICAgLy8gbm9ybWFsaXplICh0byBjYW1lbCBjYXNlKSBhbGwgdG9wLWxldmVsIHByb3BlcnR5IG5hbWVzIG9mIHRoZSBjb25maWcgZmlsZVxuICAgICAgY29uZmlnUmVzdWx0LmNvbmZpZyA9IG5vcm1hbGl6ZUNvbmZpZyhcbiAgICAgICAgLyoqIEB0eXBlIHtBcHBpdW1Db25maWd9ICovIChjb25maWdSZXN1bHQuY29uZmlnKSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBjb25maWdSZXN1bHQ7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIGNsZWFuIHVwIHRoZSByYXcgY29uZmlnIGZpbGUgY2FjaGUsIHdoaWNoIGlzIG9ubHkga2VwdCB0byBiZXR0ZXIgcmVwb3J0IGVycm9ycy5cbiAgICAgIHJhd0NvbmZpZy5kZWxldGUocmVzdWx0LmZpbGVwYXRoKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdCA/PyB7fTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IHNjaGVtYSBwcm9wZXJ0eSBuYW1lcyB0byBlaXRoZXIgYSkgdGhlIHZhbHVlIG9mIHRoZSBgYXBwaXVtQ2xpRGVzdGAgcHJvcGVydHksIGlmIGFueTsgb3IgYikgY2FtZWwtY2FzZVxuICogQHBhcmFtIHtBcHBpdW1Db25maWd9IGNvbmZpZyAtIENvbmZpZ3VyYXRpb24gb2JqZWN0XG4gKiBAcmV0dXJucyB7Tm9ybWFsaXplZEFwcGl1bUNvbmZpZ30gTmV3IG9iamVjdCB3aXRoIGNhbWVsLWNhc2VkIGtleXMgKG9yIGBkZXN0YCBrZXlzKS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZUNvbmZpZyAoY29uZmlnKSB7XG4gIGNvbnN0IHNjaGVtYSA9IGdldFNjaGVtYSgpO1xuICAvKipcbiAgICogQHBhcmFtIHtBcHBpdW1Db25maWd9IGNvbmZpZ1xuICAgKiBAcGFyYW0ge3N0cmluZ30gW3NlY3Rpb25dIC0gS2V5cGF0aCAobG9kYXNoIGBfLmdldCgpYCBzdHlsZSkgdG8gc2VjdGlvbiBvZiBjb25maWcuIElmIG9taXR0ZWQsIGFzc3VtZSByb290IEFwcGl1bSBjb25maWcgc2NoZW1hXG4gICAqIEB0b2RvIFJld3JpdGUgYXMgYSBsb29wXG4gICAqIEByZXR1cm5zIE5vcm1hbGl6ZWQgc2VjdGlvbiBvZiBjb25maWdcbiAgICovXG4gIGNvbnN0IG5vcm1hbGl6ZSA9IChjb25maWcsIHNlY3Rpb24pID0+IHtcbiAgICBjb25zdCBvYmogPSBfLmlzVW5kZWZpbmVkKHNlY3Rpb24pID8gY29uZmlnIDogXy5nZXQoY29uZmlnLCBzZWN0aW9uLCBjb25maWcpO1xuXG4gICAgY29uc3QgbWFwcGVkT2JqID0gXy5tYXBLZXlzKG9iaiwgKF9fLCBwcm9wKSA9PlxuICAgICAgc2NoZW1hLnByb3BlcnRpZXNbcHJvcF0/LmFwcGl1bUNsaURlc3QgPz8gXy5jYW1lbENhc2UocHJvcCksXG4gICAgKTtcblxuICAgIHJldHVybiBfLm1hcFZhbHVlcyhtYXBwZWRPYmosICh2YWx1ZSwgcHJvcGVydHkpID0+IHtcbiAgICAgIGNvbnN0IG5leHRTZWN0aW9uID0gc2VjdGlvbiA/IGAke3NlY3Rpb259LiR7cHJvcGVydHl9YCA6IHByb3BlcnR5O1xuICAgICAgcmV0dXJuIGlzU2NoZW1hVHlwZU9iamVjdCh2YWx1ZSkgPyBub3JtYWxpemUoY29uZmlnLCBuZXh0U2VjdGlvbikgOiB2YWx1ZTtcbiAgICB9KTtcbiAgfTtcblxuICAvKipcbiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHNjaGVtYSBwcm9wIHJlZmVyZW5jZXMgYW4gb2JqZWN0LCBvciBpZiBpdCdzIGFuIG9iamVjdCBpdHNlbGZcbiAgICogQHBhcmFtIHtpbXBvcnQoJ2FqdicpLlNjaGVtYU9iamVjdHxvYmplY3R9IHNjaGVtYSAtIFJlZmVyZW5jaW5nIHNjaGVtYSBvYmplY3RcbiAgICovXG4gIGNvbnN0IGlzU2NoZW1hVHlwZU9iamVjdCA9IChzY2hlbWEpID0+IEJvb2xlYW4oc2NoZW1hLnByb3BlcnRpZXMpO1xuXG4gIHJldHVybiBub3JtYWxpemUoY29uZmlnKTtcbn1cblxuLyoqXG4gKiBSZXN1bHQgb2YgY2FsbGluZyB7QGxpbmsgcmVhZENvbmZpZ0ZpbGV9LlxuICogQHR5cGVkZWYge09iamVjdH0gUmVhZENvbmZpZ0ZpbGVSZXN1bHRcbiAqIEBwcm9wZXJ0eSB7aW1wb3J0KCdhanYnKS5FcnJvck9iamVjdFtdfSBbZXJyb3JzXSAtIFZhbGlkYXRpb24gZXJyb3JzXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW2ZpbGVwYXRoXSAtIFRoZSBwYXRoIHRvIHRoZSBjb25maWcgZmlsZSwgaWYgZm91bmRcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2lzRW1wdHldIC0gSWYgYHRydWVgLCB0aGUgY29uZmlnIGZpbGUgZXhpc3RzIGJ1dCBpcyBlbXB0eVxuICogQHByb3BlcnR5IHtOb3JtYWxpemVkQXBwaXVtQ29uZmlnfSBbY29uZmlnXSAtIFRoZSBwYXJzZWQgY29uZmlndXJhdGlvblxuICogQHByb3BlcnR5IHtzdHJpbmd8YmV0dGVyQWp2RXJyb3JzLklPdXRwdXRFcnJvcltdfSBbcmVhc29uXSAtIEh1bWFuLXJlYWRhYmxlIGVycm9yIG1lc3NhZ2VzIGFuZCBzdWdnZXN0aW9ucy4gSWYgdGhlIGBwcmV0dHlgIG9wdGlvbiBpcyBgdHJ1ZWAsIHRoaXMgd2lsbCBiZSBhIG5pY2Ugc3RyaW5nIHRvIHByaW50LlxuICovXG5cbi8qKlxuICogT3B0aW9ucyBmb3Ige0BsaW5rIHJlYWRDb25maWdGaWxlfS5cbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJlYWRDb25maWdGaWxlT3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSBbcHJldHR5PXRydWVdIElmIGBmYWxzZWAsIGRvIG5vdCB1c2UgY29sb3IgYW5kIGZhbmN5IGZvcm1hdHRpbmcgaW4gdGhlIGByZWFzb25gIHByb3BlcnR5IG9mIHRoZSB7QGxpbmsgUmVhZENvbmZpZ0ZpbGVSZXN1bHR9LiBUaGUgdmFsdWUgb2YgYHJlYXNvbmAgaXMgdGhlbiBzdWl0YWJsZSBmb3IgbWFjaGluZS1yZWFkaW5nLlxuICovXG5cbi8qKlxuICogVGhpcyBpcyBhbiBgQXN5bmNTZWFyY2hlcmAgd2hpY2ggaXMgaW5leHBsaWNhYmx5IF9ub3RfIGV4cG9ydGVkIGJ5IHRoZSBgbGlsY29uZmlnYCB0eXBlIGRlZmluaXRpb24uXG4gKiBAdHlwZWRlZiB7UmV0dXJuVHlwZTxpbXBvcnQoJ2xpbGNvbmZpZycpW1wibGlsY29uZmlnXCJdPn0gTGlsY29uZmlnQXN5bmNTZWFyY2hlclxuICovXG5cbi8qKlxuICogVGhlIGNvbnRlbnRzIG9mIGFuIEFwcGl1bSBjb25maWcgZmlsZS4gR2VuZXJhdGVkIGZyb20gc2NoZW1hXG4gKiBAdHlwZWRlZiB7aW1wb3J0KCcuLi90eXBlcy90eXBlcycpLkFwcGl1bUNvbmZpZ30gQXBwaXVtQ29uZmlnXG4gKi9cblxuLyoqXG4gKiBUaGUgY29udGVudHMgb2YgYW4gQXBwaXVtIGNvbmZpZyBmaWxlIHdpdGggY2FtZWxjYXNlZCBwcm9wZXJ0eSBuYW1lcyAoYW5kIHVzaW5nIGBhcHBpdW1DbGlEZXN0YCB2YWx1ZSBpZiBwcmVzZW50KS4gR2VuZXJhdGVkIGZyb20ge0BsaW5rIEFwcGl1bUNvbmZpZ31cbiAqIEB0eXBlZGVmIHtpbXBvcnQoJy4uL3R5cGVzL3R5cGVzJykuTm9ybWFsaXplZEFwcGl1bUNvbmZpZ30gTm9ybWFsaXplZEFwcGl1bUNvbmZpZ1xuICovXG5cbi8qKlxuICogVGhlIHN0cmluZyBzaG91bGQgYmUgYSByYXcgSlNPTiBzdHJpbmcuXG4gKiBAdHlwZWRlZiB7c3RyaW5nfSBSYXdKc29uXG4gKi9cblxuLyoqXG4gKiBPcHRpb25zIGZvciB7QGxpbmsgZm9ybWF0RXJyb3JzfS5cbiAqIEB0eXBlZGVmIHtPYmplY3R9IEZvcm1hdENvbmZpZ0Vycm9yc09wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7aW1wb3J0KCcuL2NvbmZpZy1maWxlJykuUmF3SnNvbn0gW2pzb25dIC0gUmF3IEpTT04gY29uZmlnIChhcyBzdHJpbmcpXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtwcmV0dHk9dHJ1ZV0gLSBXaGV0aGVyIHRvIGZvcm1hdCBlcnJvcnMgYXMgYSBDTEktZnJpZW5kbHkgc3RyaW5nXG4gKiBAcHJvcGVydHkge3N0cmluZ30gIFtzY2hlbWFJZF0gLSBTcGVjaWZpYyBJRCBvZiBhIHByb3A7IG90aGVyd2lzZSBlbnRpcmUgc2NoZW1hXG4gKi9cbiJdLCJmaWxlIjoibGliL2NvbmZpZy1maWxlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
