"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.e2eSetup = void 0;
/* eslint-disable no-console */
const teen_process_1 = require("teen_process");
const appium_1 = require("appium");
function e2eSetup(opts = {}) {
    let { before, after, server, appiumHome, driverSource, driverPackage, driverName, driverSpec, pluginSource, pluginPackage, pluginSpec, pluginName, port, host, } = opts;
    before(function () {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            console.log('Checking whether driver dep is installed');
            let listArgs = ['appium', 'driver', 'list', '--home', appiumHome, '--json'];
            let { stdout } = yield (0, teen_process_1.exec)('npx', listArgs);
            let installed = JSON.parse(stdout);
            if (!((_a = installed[driverName]) === null || _a === void 0 ? void 0 : _a.installed)) {
                console.log('Not installed, installing...');
                const driverArgs = ['appium', 'driver', 'install', '--home', appiumHome, '--source', driverSource, driverSpec];
                if (driverPackage) {
                    driverArgs.push('--package', driverPackage);
                }
                yield (0, teen_process_1.exec)('npx', driverArgs);
            }
            console.log('Driver dep is installed');
            console.log('Checking whether plugin is installed');
            listArgs = ['appium', 'plugin', 'list', '--home', appiumHome, '--json'];
            ({ stdout } = yield (0, teen_process_1.exec)('npx', listArgs));
            installed = JSON.parse(stdout);
            if (!((_b = installed[pluginName]) === null || _b === void 0 ? void 0 : _b.installed)) {
                console.log('Installing the local version of this plugin');
                const pluginArgs = ['appium', 'plugin', 'install', '--home', appiumHome, '--source', pluginSource, pluginSpec];
                if (pluginPackage) {
                    pluginArgs.push('--package', pluginPackage);
                }
                yield (0, teen_process_1.exec)('npx', pluginArgs);
            }
            console.log('This plugin is installed');
            const args = { port, host, appiumHome, plugins: [pluginName] };
            server = yield (0, appium_1.main)(args);
        });
    });
    after(function () {
        if (server) {
            server.close();
        }
    });
}
exports.e2eSetup = e2eSetup;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsidGVzdC9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLCtCQUErQjtBQUMvQiwrQ0FBb0M7QUFDcEMsbUNBQThDO0FBRTlDLFNBQVMsUUFBUSxDQUFFLElBQUksR0FBRyxFQUFFO0lBQzFCLElBQUksRUFDRixNQUFNLEVBQ04sS0FBSyxFQUNMLE1BQU0sRUFDTixVQUFVLEVBQ1YsWUFBWSxFQUNaLGFBQWEsRUFDYixVQUFVLEVBQ1YsVUFBVSxFQUNWLFlBQVksRUFDWixhQUFhLEVBQ2IsVUFBVSxFQUNWLFVBQVUsRUFDVixJQUFJLEVBQ0osSUFBSSxHQUNMLEdBQUcsSUFBSSxDQUFDO0lBRVQsTUFBTSxDQUFDOzs7WUFDTCxPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7WUFDeEQsSUFBSSxRQUFRLEdBQUcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzVFLElBQUksRUFBQyxNQUFNLEVBQUMsR0FBRyxNQUFNLElBQUEsbUJBQUksRUFBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDM0MsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVuQyxJQUFJLENBQUMsQ0FBQSxNQUFBLFNBQVMsQ0FBQyxVQUFVLENBQUMsMENBQUUsU0FBUyxDQUFBLEVBQUU7Z0JBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLENBQUMsQ0FBQztnQkFDNUMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQy9HLElBQUksYUFBYSxFQUFFO29CQUNqQixVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztpQkFDN0M7Z0JBQ0QsTUFBTSxJQUFBLG1CQUFJLEVBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQy9CO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBRXZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLENBQUMsQ0FBQztZQUNwRCxRQUFRLEdBQUcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ3hFLENBQUMsRUFBQyxNQUFNLEVBQUMsR0FBRyxNQUFNLElBQUEsbUJBQUksRUFBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUN6QyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUvQixJQUFJLENBQUMsQ0FBQSxNQUFBLFNBQVMsQ0FBQyxVQUFVLENBQUMsMENBQUUsU0FBUyxDQUFBLEVBQUU7Z0JBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLENBQUMsQ0FBQztnQkFDM0QsTUFBTSxVQUFVLEdBQUcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQy9HLElBQUksYUFBYSxFQUFFO29CQUNqQixVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztpQkFDN0M7Z0JBQ0QsTUFBTSxJQUFBLG1CQUFJLEVBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQy9CO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1lBRXhDLE1BQU0sSUFBSSxHQUFHLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLENBQUMsVUFBVSxDQUFDLEVBQUMsQ0FBQztZQUM3RCxNQUFNLEdBQUcsTUFBTSxJQUFBLGFBQVksRUFBQyxJQUFJLENBQUMsQ0FBQzs7S0FDbkMsQ0FBQyxDQUFDO0lBRUgsS0FBSyxDQUFDO1FBQ0osSUFBSSxNQUFNLEVBQUU7WUFDVixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDaEI7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFUSw0QkFBUSJ9