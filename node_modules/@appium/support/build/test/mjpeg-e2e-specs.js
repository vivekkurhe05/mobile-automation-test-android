"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _lib = require("../lib");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _http = _interopRequireDefault(require("http"));

var _mjpegServer = _interopRequireDefault(require("mjpeg-server"));

var _getPort = _interopRequireDefault(require("get-port"));

const {
  MJpegStream
} = _lib.mjpeg;
const TEST_IMG_JPG = '/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAAeAAD/4QOBaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6NGY5ODc1OTctZGE2My00Y2M0LTkzNDMtNGYyNjgzMGUwNjk3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjlDMzI3QkY0N0Q3NTExRThCMTlDOTVDMDc2RDE5MDY5IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjlDMzI3QkYzN0Q3NTExRThCMTlDOTVDMDc2RDE5MDY5IiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE4IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NGY5ODc1OTctZGE2My00Y2M0LTkzNDMtNGYyNjgzMGUwNjk3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRmOTg3NTk3LWRhNjMtNGNjNC05MzQzLTRmMjY4MzBlMDY5NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pv/uAA5BZG9iZQBkwAAAAAH/2wCEABALCwsMCxAMDBAXDw0PFxsUEBAUGx8XFxcXFx8eFxoaGhoXHh4jJSclIx4vLzMzLy9AQEBAQEBAQEBAQEBAQEABEQ8PERMRFRISFRQRFBEUGhQWFhQaJhoaHBoaJjAjHh4eHiMwKy4nJycuKzU1MDA1NUBAP0BAQEBAQEBAQEBAQP/AABEIACAAIAMBIgACEQEDEQH/xABgAAEAAwEAAAAAAAAAAAAAAAAABAUHCAEBAAAAAAAAAAAAAAAAAAAAABAAAQMCAgsAAAAAAAAAAAAAAAECBBEDEgYhMRODo7PTVAUWNhEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Az8AAdAAAAAAI8+fE8dEuTZtzZR7VMb6OdTE5GJoYirrUp/e8qd9wb3TGe/lJ2551sx8D/9k=';
const MJPEG_HOST = '127.0.0.1';

function initMJpegServer(port, intMs = 300, times = 20) {
  const server = _http.default.createServer(async function (req, res) {
    const mJpegReqHandler = _mjpegServer.default.createReqHandler(req, res);

    const jpg = Buffer.from(TEST_IMG_JPG, 'base64');

    for (let i = 0; i < times; i++) {
      await _bluebird.default.delay(intMs);

      mJpegReqHandler._write(jpg, null, _lodash.default.noop);
    }

    mJpegReqHandler.close();
  }).listen(port);

  return server;
}

describe('MJpeg Stream (e2e)', function () {
  let mJpegServer, stream;
  let serverUrl, port;
  before(async function () {
    if (process.version.startsWith('v12')) {
      return this.skip();
    }

    port = await (0, _getPort.default)();
    serverUrl = `http://${MJPEG_HOST}:${port}`;
    mJpegServer = await initMJpegServer(port);
  });
  after(function () {
    if (mJpegServer) {
      mJpegServer.close();
    }

    if (stream) {
      stream.stop();
    }
  });
  it('should update mjpeg stream based on new data from mjpeg server', async function () {
    stream = new MJpegStream(serverUrl, _lodash.default.noop);
    should.not.exist(stream.lastChunk);
    await stream.start();
    should.exist(stream.lastChunk);
    stream.updateCount.should.eql(1);
    await _bluebird.default.delay(1000);
    stream.updateCount.should.be.above(1);
    const startBytes = Buffer.from([0xff, 0xd8]);
    const endBytes = Buffer.from([0xff, 0xd9]);
    const startPos = stream.lastChunk.indexOf(startBytes);
    const endPos = stream.lastChunk.indexOf(endBytes);
    startPos.should.eql(0);
    endPos.should.eql(1278);
    const b64 = stream.lastChunkBase64;
    b64.should.eql(TEST_IMG_JPG);
    const png = await stream.lastChunkPNGBase64();
    png.should.be.a('string');
    png.indexOf('iVBOR').should.eql(0);
    png.length.should.be.above(400);
    stream.stop();
    await _bluebird.default.delay(1000);
    should.not.exist(stream.lastChunk);
    stream.updateCount.should.eql(0);
  });
  it('should error out if the server does not send any images before a timeout', async function () {
    stream = new MJpegStream(serverUrl, _lodash.default.noop);
    await stream.start(0).should.eventually.be.rejectedWith(/never sent/);
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvbWpwZWctZTJlLXNwZWNzLmpzIl0sIm5hbWVzIjpbIk1KcGVnU3RyZWFtIiwibWpwZWciLCJURVNUX0lNR19KUEciLCJNSlBFR19IT1NUIiwiaW5pdE1KcGVnU2VydmVyIiwicG9ydCIsImludE1zIiwidGltZXMiLCJzZXJ2ZXIiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwicmVxIiwicmVzIiwibUpwZWdSZXFIYW5kbGVyIiwibUpwZWdTZXJ2ZXIiLCJjcmVhdGVSZXFIYW5kbGVyIiwianBnIiwiQnVmZmVyIiwiZnJvbSIsImkiLCJCIiwiZGVsYXkiLCJfd3JpdGUiLCJfIiwibm9vcCIsImNsb3NlIiwibGlzdGVuIiwiZGVzY3JpYmUiLCJzdHJlYW0iLCJzZXJ2ZXJVcmwiLCJiZWZvcmUiLCJwcm9jZXNzIiwidmVyc2lvbiIsInN0YXJ0c1dpdGgiLCJza2lwIiwiYWZ0ZXIiLCJzdG9wIiwiaXQiLCJzaG91bGQiLCJub3QiLCJleGlzdCIsImxhc3RDaHVuayIsInN0YXJ0IiwidXBkYXRlQ291bnQiLCJlcWwiLCJiZSIsImFib3ZlIiwic3RhcnRCeXRlcyIsImVuZEJ5dGVzIiwic3RhcnRQb3MiLCJpbmRleE9mIiwiZW5kUG9zIiwiYjY0IiwibGFzdENodW5rQmFzZTY0IiwicG5nIiwibGFzdENodW5rUE5HQmFzZTY0IiwiYSIsImxlbmd0aCIsImV2ZW50dWFsbHkiLCJyZWplY3RlZFdpdGgiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU07QUFBQ0EsRUFBQUE7QUFBRCxJQUFnQkMsVUFBdEI7QUFFQSxNQUFNQyxZQUFZLEdBQUcsOHFEQUFyQjtBQUVBLE1BQU1DLFVBQVUsR0FBRyxXQUFuQjs7QUFXQSxTQUFTQyxlQUFULENBQTBCQyxJQUExQixFQUFnQ0MsS0FBSyxHQUFHLEdBQXhDLEVBQTZDQyxLQUFLLEdBQUcsRUFBckQsRUFBeUQ7QUFDdkQsUUFBTUMsTUFBTSxHQUFHQyxj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IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IG1qcGVnIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IG1KcGVnU2VydmVyIGZyb20gJ21qcGVnLXNlcnZlcic7XG5pbXBvcnQgZ2V0UG9ydCBmcm9tICdnZXQtcG9ydCc7XG5cbmNvbnN0IHtNSnBlZ1N0cmVhbX0gPSBtanBlZztcblxuY29uc3QgVEVTVF9JTUdfSlBHID0gJy85ai80UUFZUlhocFpnQUFTVWtxQUFnQUFBQUFBQUFBQUFBQUFQL3NBQkZFZFdOcmVRQUJBQVFBQUFBZUFBRC80UU9CYUhSMGNEb3ZMMjV6TG1Ga2IySmxMbU52YlM5NFlYQXZNUzR3THdBOFAzaHdZV05yWlhRZ1ltVm5hVzQ5SXUrN3Z5SWdhV1E5SWxjMVRUQk5jRU5sYUdsSWVuSmxVM3BPVkdONmEyTTVaQ0kvUGlBOGVEcDRiWEJ0WlhSaElIaHRiRzV6T25nOUltRmtiMkpsT201ek9tMWxkR0V2SWlCNE9uaHRjSFJyUFNKQlpHOWlaU0JZVFZBZ1EyOXlaU0ExTGpZdFl6RTBNQ0EzT1M0eE5qQTBOVEVzSURJd01UY3ZNRFV2TURZdE1ERTZNRGc2TWpFZ0lDQWdJQ0FnSUNJK0lEeHlaR1k2VWtSR0lIaHRiRzV6T25Ka1pqMGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNVGs1T1M4d01pOHlNaTF5WkdZdGMzbHVkR0Y0TFc1ekl5SStJRHh5WkdZNlJHVnpZM0pwY0hScGIyNGdjbVJtT21GaWIzVjBQU0lpSUhodGJHNXpPbmh0Y0UxTlBTSm9kSFJ3T2k4dmJuTXVZV1J2WW1VdVkyOXRMM2hoY0M4eExqQXZiVzB2SWlCNGJXeHVjenB6ZEZKbFpqMGlhSFIwY0RvdkwyNXpMbUZrYjJKbExtTnZiUzk0WVhBdk1TNHdMM05VZVhCbEwxSmxjMjkxY21ObFVtVm1JeUlnZUcxc2JuTTZlRzF3UFNKb2RIUndPaTh2Ym5NdVlXUnZZbVV1WTI5dEwzaGhjQzh4TGpBdklpQjRiWEJOVFRwUGNtbG5hVzVoYkVSdlkzVnRaVzUwU1VROUluaHRjQzVrYVdRNk5HWTVPRGMxT1RjdFpHRTJNeTAwWTJNMExUa3pORE10TkdZeU5qZ3pNR1V3TmprM0lpQjRiWEJOVFRwRWIyTjFiV1Z1ZEVsRVBTSjRiWEF1Wkdsa09qbERNekkzUWtZME4wUTNOVEV4UlRoQ01UbERPVFZETURjMlJERTVNRFk1SWlCNGJYQk5UVHBKYm5OMFlXNWpaVWxFUFNKNGJYQXVhV2xrT2psRE16STNRa1l6TjBRM05URXhSVGhDTVRsRE9UVkRNRGMyUkRFNU1EWTVJaUI0YlhBNlEzSmxZWFJ2Y2xSdmIydzlJa0ZrYjJKbElGQm9iM1J2YzJodmNDQkRReUF5TURFNElDaE5ZV05wYm5SdmMyZ3BJajRnUEhodGNFMU5Pa1JsY21sMlpXUkdjbTl0SUhOMFVtVm1PbWx1YzNSaGJtTmxTVVE5SW5odGNDNXBhV1E2TkdZNU9EYzFPVGN0WkdFMk15MDBZMk0wTFRrek5ETXROR1l5Tmpnek1HVXdOamszSWlCemRGSmxaanBrYjJOMWJXVnVkRWxFUFNKNGJYQXVaR2xrT2pSbU9UZzNOVGszTFdSaE5qTXROR05qTkMwNU16UXpMVFJtTWpZNE16QmxNRFk1TnlJdlBpQThMM0prWmpwRVpYTmpjbWx3ZEdsdmJqNGdQQzl5WkdZNlVrUkdQaUE4TDNnNmVHMXdiV1YwWVQ0Z1BEOTRjR0ZqYTJWMElHVnVaRDBpY2lJL1B2L3VBQTVCWkc5aVpRQmt3QUFBQUFILzJ3Q0VBQkFMQ3dzTUN4QU1EQkFYRHcwUEZ4c1VFQkFVR3g4WEZ4Y1hGeDhlRnhvYUdob1hIaDRqSlNjbEl4NHZMek16THk5QVFFQkFRRUJBUUVCQVFFQkFRRUFCRVE4UEVSTVJGUklTRlJRUkZCRVVHaFFXRmhRYUpob2FIQm9hSmpBakhoNGVIaU13S3k0bkp5Y3VLelUxTURBMU5VQkFQMEJBUUVCQVFFQkFRRUJBUVAvQUFCRUlBQ0FBSUFNQklnQUNFUUVERVFIL3hBQmdBQUVBQXdFQUFBQUFBQUFBQUFBQUFBQUFCQVVIQ0FFQkFBQUFBQUFBQUFBQUFBQUFBQUFBQUJBQUFRTUNBZ3NBQUFBQUFBQUFBQUFBQUFFQ0JCRURFZ1loTVJPRG83UFRWQVVXTmhFQkFBQUFBQUFBQUFBQUFBQUFBQUFBQVAvYUFBd0RBUUFDRVFNUkFEOEF6OEFBZEFBQUFBQUk4K2ZFOGRFdVRadHpaUjdWTWI2T2RURTVHSm9ZaXJyVXAvZThxZDl3YjNUR2UvbEoyNTUxc3g4RC85az0nO1xuXG5jb25zdCBNSlBFR19IT1NUID0gJzEyNy4wLjAuMSc7XG5cbi8qKlxuICogU3RhcnQgYW4gbWpwZWcgc2VydmVyIGZvciB0aGUgcHVycG9zZSBvZiB0ZXN0aW5nLCB3aGljaCBqdXN0IHNlbmRzIHRoZSBzYW1lXG4gKiBpbWFnZSBvdmVyIGFuZCBvdmVyLiBDYWxsZXIgaXMgcmVzcG9uc2libGUgZm9yIGNsb3NpbmcgdGhlIHNlcnZlci5cbiAqIEBwYXJhbSB7aW50fSBwb3J0IC0gcG9ydCB0aGUgc2VydmVyIHNob3VsZCBsaXN0ZW4gb25cbiAqIEBwYXJhbSB7aW50fSBbaW50TXNdIC0gaG93IG9mdGVuIHRoZSBzZXJ2ZXIgc2hvdWxkIHB1c2ggYW4gaW1hZ2VcbiAqIEBwYXJhbSB7aW50fSBbdGltZXNdIC0gaG93IG1hbnkgdGltZXMgdGhlIHNlcnZlciBzaG91bGQgcHVzaCBhbiBpbWFnZSBiZWZvcmVcbiAqIGl0IGNsb3NlcyB0aGUgY29ubmVjdGlvblxuICogQHJldHVybnMge2h0dHAuU2VydmVyfVxuICovXG5mdW5jdGlvbiBpbml0TUpwZWdTZXJ2ZXIgKHBvcnQsIGludE1zID0gMzAwLCB0aW1lcyA9IDIwKSB7XG4gIGNvbnN0IHNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFzeW5jIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGNvbnN0IG1KcGVnUmVxSGFuZGxlciA9IG1KcGVnU2VydmVyLmNyZWF0ZVJlcUhhbmRsZXIocmVxLCByZXMpO1xuICAgIGNvbnN0IGpwZyA9IEJ1ZmZlci5mcm9tKFRFU1RfSU1HX0pQRywgJ2Jhc2U2NCcpO1xuXG4gICAgLy8ganVzdCBzZW5kIHRoZSBzYW1lIGpwZWcgb3ZlciBhbmQgb3ZlclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXM7IGkrKykge1xuICAgICAgYXdhaXQgQi5kZWxheShpbnRNcyk7XG4gICAgICBtSnBlZ1JlcUhhbmRsZXIuX3dyaXRlKGpwZywgbnVsbCwgXy5ub29wKTtcbiAgICB9XG4gICAgbUpwZWdSZXFIYW5kbGVyLmNsb3NlKCk7XG4gIH0pLmxpc3Rlbihwb3J0KTtcblxuICByZXR1cm4gc2VydmVyO1xufVxuXG5cbmRlc2NyaWJlKCdNSnBlZyBTdHJlYW0gKGUyZSknLCBmdW5jdGlvbiAoKSB7XG4gIGxldCBtSnBlZ1NlcnZlciwgc3RyZWFtO1xuICBsZXQgc2VydmVyVXJsLCBwb3J0O1xuXG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgLy8gVE9ETzogcmVtb3ZlIHdoZW4gYnVmZmVydG9vbHMgY2FuIGhhbmRsZSB2MTJcbiAgICBpZiAocHJvY2Vzcy52ZXJzaW9uLnN0YXJ0c1dpdGgoJ3YxMicpKSB7XG4gICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgfVxuXG4gICAgcG9ydCA9IGF3YWl0IGdldFBvcnQoKTtcbiAgICBzZXJ2ZXJVcmwgPSBgaHR0cDovLyR7TUpQRUdfSE9TVH06JHtwb3J0fWA7XG4gICAgbUpwZWdTZXJ2ZXIgPSBhd2FpdCBpbml0TUpwZWdTZXJ2ZXIocG9ydCk7XG4gIH0pO1xuXG4gIGFmdGVyKGZ1bmN0aW9uICgpIHtcbiAgICBpZiAobUpwZWdTZXJ2ZXIpIHtcbiAgICAgIG1KcGVnU2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICAgIGlmIChzdHJlYW0pIHtcbiAgICAgIHN0cmVhbS5zdG9wKCk7IC8vIGVuc3VyZSBzdHJlYW1zIGFyZSBhbHdheXMgc3RvcHBlZFxuICAgIH1cbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB1cGRhdGUgbWpwZWcgc3RyZWFtIGJhc2VkIG9uIG5ldyBkYXRhIGZyb20gbWpwZWcgc2VydmVyJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHN0cmVhbSA9IG5ldyBNSnBlZ1N0cmVhbShzZXJ2ZXJVcmwsIF8ubm9vcCk7XG4gICAgc2hvdWxkLm5vdC5leGlzdChzdHJlYW0ubGFzdENodW5rKTtcbiAgICBhd2FpdCBzdHJlYW0uc3RhcnQoKTtcbiAgICBzaG91bGQuZXhpc3Qoc3RyZWFtLmxhc3RDaHVuayk7XG4gICAgc3RyZWFtLnVwZGF0ZUNvdW50LnNob3VsZC5lcWwoMSk7XG5cbiAgICBhd2FpdCBCLmRlbGF5KDEwMDApOyAvLyBsZXQgdGhlIHN0cmVhbSB1cGRhdGUgYSBiaXRcbiAgICBzdHJlYW0udXBkYXRlQ291bnQuc2hvdWxkLmJlLmFib3ZlKDEpO1xuXG4gICAgLy8gdmVyaWZ5IGpwZWcgdHlwZSBhbmQgYnl0ZSBsZW5ndGggb2YgZml4dHVyZSBpbWFnZVxuICAgIGNvbnN0IHN0YXJ0Qnl0ZXMgPSBCdWZmZXIuZnJvbShbMHhmZiwgMHhkOF0pO1xuICAgIGNvbnN0IGVuZEJ5dGVzID0gQnVmZmVyLmZyb20oWzB4ZmYsIDB4ZDldKTtcbiAgICBjb25zdCBzdGFydFBvcyA9IHN0cmVhbS5sYXN0Q2h1bmsuaW5kZXhPZihzdGFydEJ5dGVzKTtcbiAgICBjb25zdCBlbmRQb3MgPSBzdHJlYW0ubGFzdENodW5rLmluZGV4T2YoZW5kQnl0ZXMpO1xuICAgIHN0YXJ0UG9zLnNob3VsZC5lcWwoMCk7IC8vIHByb3ZlcyB3ZSBoYXZlIGEganBlZ1xuICAgIGVuZFBvcy5zaG91bGQuZXFsKDEyNzgpOyAvLyBwcm92ZXMgd2UgaGF2ZSBhIGpwZWcgb2YgdGhlIHJpZ2h0IHNpemVcblxuICAgIC8vIHZlcmlmeSB3ZSBjYW4gZ2V0IHRoZSBiYXNlNjQgdmVyc2lvbiB0b29cbiAgICBjb25zdCBiNjQgPSBzdHJlYW0ubGFzdENodW5rQmFzZTY0O1xuICAgIGI2NC5zaG91bGQuZXFsKFRFU1RfSU1HX0pQRyk7XG5cbiAgICAvLyB2ZXJpZnkgd2UgY2FuIGdldCB0aGUgUE5HIHZlcnNpb24gdG9vXG4gICAgY29uc3QgcG5nID0gYXdhaXQgc3RyZWFtLmxhc3RDaHVua1BOR0Jhc2U2NCgpO1xuICAgIHBuZy5zaG91bGQuYmUuYSgnc3RyaW5nJyk7XG4gICAgcG5nLmluZGV4T2YoJ2lWQk9SJykuc2hvdWxkLmVxbCgwKTtcbiAgICBwbmcubGVuZ3RoLnNob3VsZC5iZS5hYm92ZSg0MDApO1xuXG5cbiAgICAvLyBub3cgc3RvcCB0aGUgc3RyZWFtIGFuZCB3YWl0IHNvbWUgbW9yZSB0aGVuIGFzc2VydCBubyBuZXcgZGF0YSBoYXMgY29tZSBpblxuICAgIHN0cmVhbS5zdG9wKCk7XG4gICAgYXdhaXQgQi5kZWxheSgxMDAwKTtcbiAgICBzaG91bGQubm90LmV4aXN0KHN0cmVhbS5sYXN0Q2h1bmspO1xuICAgIHN0cmVhbS51cGRhdGVDb3VudC5zaG91bGQuZXFsKDApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGVycm9yIG91dCBpZiB0aGUgc2VydmVyIGRvZXMgbm90IHNlbmQgYW55IGltYWdlcyBiZWZvcmUgYSB0aW1lb3V0JywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHN0cmVhbSA9IG5ldyBNSnBlZ1N0cmVhbShzZXJ2ZXJVcmwsIF8ubm9vcCk7XG4gICAgYXdhaXQgc3RyZWFtLnN0YXJ0KDApLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvbmV2ZXIgc2VudC8pO1xuICB9KTtcblxufSk7XG4iXSwiZmlsZSI6InRlc3QvbWpwZWctZTJlLXNwZWNzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
