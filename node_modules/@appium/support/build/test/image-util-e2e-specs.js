"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _imageUtil = require("../lib/image-util");

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _lib = require("../lib");

const FIXTURES_ROOT = _path.default.resolve(__dirname, '..', '..', 'test', 'images');

async function getImage(name) {
  const imagePath = _path.default.resolve(FIXTURES_ROOT, name);

  return await _lib.fs.readFile(imagePath, 'utf8');
}

describe('image-util', function () {
  describe('cropBase64Image', function () {
    let originalImage = null;
    before(async function () {
      const originalImage64 = await getImage('full-image.b64');
      originalImage = await (0, _imageUtil.base64ToImage)(originalImage64);
      originalImage.width.should.be.equal(640, 'unexpected width');
      originalImage.height.should.be.equal(1136, 'unexpected height');
    });
    it('should verify that an image is cropped correctly', async function () {
      const croppedImage = await (0, _imageUtil.cropImage)(originalImage, {
        left: 35,
        top: 107,
        width: 323,
        height: 485
      });
      croppedImage.width.should.be.equal(323, 'unexpected width');
      croppedImage.height.should.be.equal(485, 'unexpected height');
      const croppedImageShouldBe = await getImage('cropped-image.b64');
      const croppedImage64 = await (0, _imageUtil.imageToBase64)(croppedImage);
      croppedImage64.should.be.equal(croppedImageShouldBe);
    });
  });
  describe('Jimp helpers', function () {
    it('should get a jimp object using image buffer', async function () {
      const base64Image = await getImage('cropped-image.b64');
      const imageBuffer = Buffer.from(base64Image, 'base64');
      const jimpImg = await (0, _imageUtil.getJimpImage)(imageBuffer);
      jimpImg.hash().should.eql('80000000000');
      jimpImg.bitmap.height.should.eql(485);
      jimpImg.bitmap.width.should.eql(323);
    });
    it('should get a jimp object using b64 string', async function () {
      const base64Image = await getImage('cropped-image.b64');
      const jimpImg = await (0, _imageUtil.getJimpImage)(base64Image);
      jimpImg.hash().should.eql('80000000000');
      jimpImg.bitmap.height.should.eql(485);
      jimpImg.bitmap.width.should.eql(323);
    });
    it('should error with incorrect data type', async function () {
      await (0, _imageUtil.getJimpImage)(1234).should.eventually.be.rejectedWith(/string or buffer/);
    });
    it('should error with incorrect image data', async function () {
      await (0, _imageUtil.getJimpImage)('foo').should.eventually.be.rejectedWith(/Could not find MIME for Buffer/);
    });
    it('should get an image buffer via the overridden getBuffer method', async function () {
      const base64Image = await getImage('cropped-image.b64');
      const jimpImg = await (0, _imageUtil.getJimpImage)(base64Image);
      const buf = await jimpImg.getBuffer(_imageUtil.MIME_PNG);
      _lodash.default.isBuffer(buf).should.be.true;
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaW1hZ2UtdXRpbC1lMmUtc3BlY3MuanMiXSwibmFtZXMiOlsiRklYVFVSRVNfUk9PVCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZ2V0SW1hZ2UiLCJuYW1lIiwiaW1hZ2VQYXRoIiwiZnMiLCJyZWFkRmlsZSIsImRlc2NyaWJlIiwib3JpZ2luYWxJbWFnZSIsImJlZm9yZSIsIm9yaWdpbmFsSW1hZ2U2NCIsIndpZHRoIiwic2hvdWxkIiwiYmUiLCJlcXVhbCIsImhlaWdodCIsIml0IiwiY3JvcHBlZEltYWdlIiwibGVmdCIsInRvcCIsImNyb3BwZWRJbWFnZVNob3VsZEJlIiwiY3JvcHBlZEltYWdlNjQiLCJiYXNlNjRJbWFnZSIsImltYWdlQnVmZmVyIiwiQnVmZmVyIiwiZnJvbSIsImppbXBJbWciLCJoYXNoIiwiZXFsIiwiYml0bWFwIiwiZXZlbnR1YWxseSIsInJlamVjdGVkV2l0aCIsImJ1ZiIsImdldEJ1ZmZlciIsIk1JTUVfUE5HIiwiXyIsImlzQnVmZmVyIiwidHJ1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsYUFBYSxHQUFHQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsRUFBb0MsTUFBcEMsRUFBNEMsUUFBNUMsQ0FBdEI7O0FBRUEsZUFBZUMsUUFBZixDQUF5QkMsSUFBekIsRUFBK0I7QUFDN0IsUUFBTUMsU0FBUyxHQUFHTCxjQUFLQyxPQUFMLENBQWFGLGFBQWIsRUFBNEJLLElBQTVCLENBQWxCOztBQUNBLFNBQU8sTUFBTUUsUUFBR0MsUUFBSCxDQUFZRixTQUFaLEVBQXVCLE1BQXZCLENBQWI7QUFDRDs7QUFFREcsUUFBUSxDQUFDLFlBQUQsRUFBZSxZQUFZO0FBRWpDQSxFQUFBQSxRQUFRLENBQUMsaUJBQUQsRUFBb0IsWUFBWTtBQUN0QyxRQUFJQyxhQUFhLEdBQUcsSUFBcEI7QUFFQUMsSUFBQUEsTUFBTSxDQUFD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NkJBQWEsSUFBYixFQUFtQkosTUFBbkIsQ0FBMEJrQixVQUExQixDQUFxQ2pCLEVBQXJDLENBQXdDa0IsWUFBeEMsQ0FBcUQsa0JBQXJELENBQU47QUFDRCxLQUZDLENBQUY7QUFHQWYsSUFBQUEsRUFBRSxDQUFDLHdDQUFELEVBQTJDLGtCQUFrQjtBQUM3RCxZQUFNLDZCQUFhLEtBQWIsRUFBb0JKLE1BQXBCLENBQTJCa0IsVUFBM0IsQ0FBc0NqQixFQUF0QyxDQUF5Q2tCLFlBQXpDLENBQXNELGdDQUF0RCxDQUFOO0FBQ0QsS0FGQyxDQUFGO0FBR0FmLElBQUFBLEVBQUUsQ0FBQyxnRUFBRCxFQUFtRSxrQkFBa0I7QUFDckYsWUFBTU0sV0FBVyxHQUFHLE1BQU1wQixRQUFRLENBQUMsbUJBQUQsQ0FBbEM7QUFDQSxZQUFNd0IsT0FBTyxHQUFHLE1BQU0sNkJBQWFKLFdBQWIsQ0FBdEI7QUFDQSxZQUFNVSxHQUFHLEdBQUcsTUFBTU4sT0FBTyxDQUFDTyxTQUFSLENBQWtCQyxtQkFBbEIsQ0FBbEI7QUFDQUMsc0JBQUVDLFFBQUYsQ0FBV0osR0FBWCxFQUFnQnBCLE1BQWhCLENBQXVCQyxFQUF2QixDQUEwQndCLElBQTFCO0FBQ0QsS0FMQyxDQUFGO0FBTUQsR0E1Qk8sQ0FBUjtBQTZCRCxDQXpETyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgYmFzZTY0VG9JbWFnZSwgaW1hZ2VUb0Jhc2U2NCwgY3JvcEltYWdlLFxuICBnZXRKaW1wSW1hZ2UsIE1JTUVfUE5HLFxufSBmcm9tICcuLi9saWIvaW1hZ2UtdXRpbCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJy4uL2xpYic7XG5cblxuY29uc3QgRklYVFVSRVNfUk9PVCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICd0ZXN0JywgJ2ltYWdlcycpO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRJbWFnZSAobmFtZSkge1xuICBjb25zdCBpbWFnZVBhdGggPSBwYXRoLnJlc29sdmUoRklYVFVSRVNfUk9PVCwgbmFtZSk7XG4gIHJldHVybiBhd2FpdCBmcy5yZWFkRmlsZShpbWFnZVBhdGgsICd1dGY4Jyk7XG59XG5cbmRlc2NyaWJlKCdpbWFnZS11dGlsJywgZnVuY3Rpb24gKCkge1xuXG4gIGRlc2NyaWJlKCdjcm9wQmFzZTY0SW1hZ2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IG9yaWdpbmFsSW1hZ2UgPSBudWxsO1xuXG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsSW1hZ2U2NCA9IGF3YWl0IGdldEltYWdlKCdmdWxsLWltYWdlLmI2NCcpO1xuICAgICAgb3JpZ2luYWxJbWFnZSA9IGF3YWl0IGJhc2U2NFRvSW1hZ2Uob3JpZ2luYWxJbWFnZTY0KTtcblxuICAgICAgLy8gdmVyaWZ5IG9yaWdpbmFsIGltYWdlIHNpemUsIHRvIGJlIHN1cmUgdGhhdCBvcmlnaW5hbCBpbWFnZSBpcyBjb3JyZWN0XG4gICAgICBvcmlnaW5hbEltYWdlLndpZHRoLnNob3VsZC5iZS5lcXVhbCg2NDAsICd1bmV4cGVjdGVkIHdpZHRoJyk7XG4gICAgICBvcmlnaW5hbEltYWdlLmhlaWdodC5zaG91bGQuYmUuZXF1YWwoMTEzNiwgJ3VuZXhwZWN0ZWQgaGVpZ2h0Jyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHZlcmlmeSB0aGF0IGFuIGltYWdlIGlzIGNyb3BwZWQgY29ycmVjdGx5JywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgY3JvcHBlZEltYWdlID0gYXdhaXQgY3JvcEltYWdlKG9yaWdpbmFsSW1hZ2UsIHtsZWZ0OiAzNSwgdG9wOiAxMDcsIHdpZHRoOiAzMjMsIGhlaWdodDogNDg1fSk7XG5cbiAgICAgIC8vIHZlcmlmeSBjcm9wcGVkIGltYWdlIHNpemUsIGl0IHNob3VsZCBiZSBsZXNzIHRoYW4gb3JpZ2luYWwgaW1hZ2UgYWNjb3JkaW5nIHRvIGNyb3AgcmVnaW9uXG4gICAgICBjcm9wcGVkSW1hZ2Uud2lkdGguc2hvdWxkLmJlLmVxdWFsKDMyMywgJ3VuZXhwZWN0ZWQgd2lkdGgnKTtcbiAgICAgIGNyb3BwZWRJbWFnZS5oZWlnaHQuc2hvdWxkLmJlLmVxdWFsKDQ4NSwgJ3VuZXhwZWN0ZWQgaGVpZ2h0Jyk7XG5cbiAgICAgIC8vIHZlcmlmeSB0aGF0IGltYWdlIGNyb3BwZWQsIGNvbXBhcmUgYmFzZTY0IHJlcHJlc2VudGF0aW9uXG4gICAgICBjb25zdCBjcm9wcGVkSW1hZ2VTaG91bGRCZSA9IGF3YWl0IGdldEltYWdlKCdjcm9wcGVkLWltYWdlLmI2NCcpO1xuICAgICAgY29uc3QgY3JvcHBlZEltYWdlNjQgPSBhd2FpdCBpbWFnZVRvQmFzZTY0KGNyb3BwZWRJbWFnZSk7XG4gICAgICBjcm9wcGVkSW1hZ2U2NC5zaG91bGQuYmUuZXF1YWwoY3JvcHBlZEltYWdlU2hvdWxkQmUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnSmltcCBoZWxwZXJzJywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgZ2V0IGEgamltcCBvYmplY3QgdXNpbmcgaW1hZ2UgYnVmZmVyJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgYmFzZTY0SW1hZ2UgPSBhd2FpdCBnZXRJbWFnZSgnY3JvcHBlZC1pbWFnZS5iNjQnKTtcbiAgICAgIGNvbnN0IGltYWdlQnVmZmVyID0gQnVmZmVyLmZyb20oYmFzZTY0SW1hZ2UsICdiYXNlNjQnKTtcbiAgICAgIGNvbnN0IGppbXBJbWcgPSBhd2FpdCBnZXRKaW1wSW1hZ2UoaW1hZ2VCdWZmZXIpO1xuICAgICAgamltcEltZy5oYXNoKCkuc2hvdWxkLmVxbCgnODAwMDAwMDAwMDAnKTtcbiAgICAgIGppbXBJbWcuYml0bWFwLmhlaWdodC5zaG91bGQuZXFsKDQ4NSk7XG4gICAgICBqaW1wSW1nLmJpdG1hcC53aWR0aC5zaG91bGQuZXFsKDMyMyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBnZXQgYSBqaW1wIG9iamVjdCB1c2luZyBiNjQgc3RyaW5nJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgYmFzZTY0SW1hZ2UgPSBhd2FpdCBnZXRJbWFnZSgnY3JvcHBlZC1pbWFnZS5iNjQnKTtcbiAgICAgIGNvbnN0IGppbXBJbWcgPSBhd2FpdCBnZXRKaW1wSW1hZ2UoYmFzZTY0SW1hZ2UpO1xuICAgICAgamltcEltZy5oYXNoKCkuc2hvdWxkLmVxbCgnODAwMDAwMDAwMDAnKTtcbiAgICAgIGppbXBJbWcuYml0bWFwLmhlaWdodC5zaG91bGQuZXFsKDQ4NSk7XG4gICAgICBqaW1wSW1nLmJpdG1hcC53aWR0aC5zaG91bGQuZXFsKDMyMyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBlcnJvciB3aXRoIGluY29ycmVjdCBkYXRhIHR5cGUnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBnZXRKaW1wSW1hZ2UoMTIzNCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9zdHJpbmcgb3IgYnVmZmVyLyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBlcnJvciB3aXRoIGluY29ycmVjdCBpbWFnZSBkYXRhJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgZ2V0SmltcEltYWdlKCdmb28nKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL0NvdWxkIG5vdCBmaW5kIE1JTUUgZm9yIEJ1ZmZlci8pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgZ2V0IGFuIGltYWdlIGJ1ZmZlciB2aWEgdGhlIG92ZXJyaWRkZW4gZ2V0QnVmZmVyIG1ldGhvZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IGJhc2U2NEltYWdlID0gYXdhaXQgZ2V0SW1hZ2UoJ2Nyb3BwZWQtaW1hZ2UuYjY0Jyk7XG4gICAgICBjb25zdCBqaW1wSW1nID0gYXdhaXQgZ2V0SmltcEltYWdlKGJhc2U2NEltYWdlKTtcbiAgICAgIGNvbnN0IGJ1ZiA9IGF3YWl0IGppbXBJbWcuZ2V0QnVmZmVyKE1JTUVfUE5HKTtcbiAgICAgIF8uaXNCdWZmZXIoYnVmKS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJmaWxlIjoidGVzdC9pbWFnZS11dGlsLWUyZS1zcGVjcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
