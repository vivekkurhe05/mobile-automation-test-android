"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.COMMAND_URLS_CONFLICTS = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _support = require("@appium/support");

var _helpers = require("../basedriver/helpers");

var _constants = require("../constants");

const log = _support.logger.getLogger('Protocol Converter');

const COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute'),
  w3cConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync')
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: url => url.replace(/\/element\/([^/]+)\/screenshot$/, '/screenshot/$1'),
  w3cConverter: url => url.replace(/\/screenshot\/([^/]+)/, '/element/$1/screenshot')
}, {
  commandNames: ['getWindowHandles', 'getWindowHandle'],

  jsonwpConverter(url) {
    return /\/window$/.test(url) ? url.replace(/\/window$/, '/window_handle') : url.replace(/\/window\/handle(s?)$/, '/window_handle$1');
  },

  w3cConverter(url) {
    return /\/window_handle$/.test(url) ? url.replace(/\/window_handle$/, '/window') : url.replace(/\/window_handles$/, '/window/handles');
  }

}, {
  commandNames: ['getProperty'],
  jsonwpConverter: w3cUrl => {
    const w3cPropertyRegex = /\/element\/([^/]+)\/property\/([^/]+)/;
    const jsonwpUrl = w3cUrl.replace(w3cPropertyRegex, '/element/$1/attribute/$2');
    log.info(`Converting W3C '${w3cUrl}' to '${jsonwpUrl}'`);
    return jsonwpUrl;
  },
  w3cConverter: jsonwpUrl => jsonwpUrl
}];
exports.COMMAND_URLS_CONFLICTS = COMMAND_URLS_CONFLICTS;
const {
  MJSONWP,
  W3C
} = _constants.PROTOCOLS;

class ProtocolConverter {
  constructor(proxyFunc) {
    this.proxyFunc = proxyFunc;
    this._downstreamProtocol = null;
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getTimeoutRequestObjects(body) {
    if (this.downstreamProtocol === W3C && _lodash.default.has(body, 'ms') && _lodash.default.has(body, 'type')) {
      const typeToW3C = x => x === 'page load' ? 'pageLoad' : x;

      return [{
        [typeToW3C(body.type)]: body.ms
      }];
    }

    if (this.downstreamProtocol === MJSONWP && (!_lodash.default.has(body, 'ms') || !_lodash.default.has(body, 'type'))) {
      const typeToJSONWP = x => x === 'pageLoad' ? 'page load' : x;

      return _lodash.default.toPairs(body).filter(pair => /^\d+(?:[.,]\d*?)?$/.test(`${pair[1]}`)).map(function (pair) {
        return {
          type: typeToJSONWP(pair[0]),
          ms: pair[1]
        };
      });
    }

    return [body];
  }

  async proxySetTimeouts(url, method, body) {
    let response, resBody;
    const timeoutRequestObjects = this.getTimeoutRequestObjects(body);
    log.debug(`Will send the following request bodies to /timeouts: ${JSON.stringify(timeoutRequestObjects)}`);

    for (const timeoutObj of timeoutRequestObjects) {
      [response, resBody] = await this.proxyFunc(url, method, timeoutObj);

      if (this.downstreamProtocol !== MJSONWP) {
        return [response, resBody];
      }

      if (response.statusCode >= 400) {
        return [response, resBody];
      }
    }

    return [response, resBody];
  }

  async proxySetWindow(url, method, body) {
    const bodyObj = _support.util.safeJsonParse(body);

    if (_lodash.default.isPlainObject(bodyObj)) {
      if (this.downstreamProtocol === W3C && _lodash.default.has(bodyObj, 'name') && !_lodash.default.has(bodyObj, 'handle')) {
        log.debug(`Copied 'name' value '${bodyObj.name}' to 'handle' as per W3C spec`);
        return await this.proxyFunc(url, method, { ...bodyObj,
          handle: bodyObj.name
        });
      }

      if (this.downstreamProtocol === MJSONWP && _lodash.default.has(bodyObj, 'handle') && !_lodash.default.has(bodyObj, 'name')) {
        log.debug(`Copied 'handle' value '${bodyObj.handle}' to 'name' as per JSONWP spec`);
        return await this.proxyFunc(url, method, { ...bodyObj,
          name: bodyObj.handle
        });
      }
    }

    return await this.proxyFunc(url, method, body);
  }

  async proxySetValue(url, method, body) {
    const bodyObj = _support.util.safeJsonParse(body);

    if (_lodash.default.isPlainObject(bodyObj) && (_support.util.hasValue(bodyObj.text) || _support.util.hasValue(bodyObj.value))) {
      let {
        text,
        value
      } = bodyObj;

      if (_support.util.hasValue(text) && !_support.util.hasValue(value)) {
        value = _lodash.default.isString(text) ? [...text] : _lodash.default.isArray(text) ? text : [];
        log.debug(`Added 'value' property ${JSON.stringify(value)} to 'setValue' request body`);
      } else if (!_support.util.hasValue(text) && _support.util.hasValue(value)) {
        text = _lodash.default.isArray(value) ? value.join('') : _lodash.default.isString(value) ? value : '';
        log.debug(`Added 'text' property ${JSON.stringify(text)} to 'setValue' request body`);
      }

      return await this.proxyFunc(url, method, Object.assign({}, bodyObj, {
        text,
        value
      }));
    }

    return await this.proxyFunc(url, method, body);
  }

  async proxySetFrame(url, method, body) {
    const bodyObj = _support.util.safeJsonParse(body);

    return _lodash.default.has(bodyObj, 'id') && _lodash.default.isPlainObject(bodyObj.id) ? await this.proxyFunc(url, method, { ...bodyObj,
      id: (0, _helpers.duplicateKeys)(bodyObj.id, _constants.MJSONWP_ELEMENT_KEY, _constants.W3C_ELEMENT_KEY)
    }) : await this.proxyFunc(url, method, body);
  }

  async proxyPerformActions(url, method, body) {
    const bodyObj = _support.util.safeJsonParse(body);

    return _lodash.default.isPlainObject(bodyObj) ? await this.proxyFunc(url, method, (0, _helpers.duplicateKeys)(bodyObj, _constants.MJSONWP_ELEMENT_KEY, _constants.W3C_ELEMENT_KEY)) : await this.proxyFunc(url, method, body);
  }

  async proxyReleaseActions(url, method) {
    return await this.proxyFunc(url, method);
  }

  async convertAndProxy(commandName, url, method, body) {
    if (!this.downstreamProtocol) {
      return await this.proxyFunc(url, method, body);
    }

    switch (commandName) {
      case 'timeouts':
        return await this.proxySetTimeouts(url, method, body);

      case 'setWindow':
        return await this.proxySetWindow(url, method, body);

      case 'setValue':
        return await this.proxySetValue(url, method, body);

      case 'performActions':
        return await this.proxyPerformActions(url, method, body);

      case 'releaseActions':
        return await this.proxyReleaseActions(url, method, body);

      case 'setFrame':
        return await this.proxySetFrame(url, method, body);

      default:
        break;
    }

    for (const {
      commandNames,
      jsonwpConverter,
      w3cConverter
    } of COMMAND_URLS_CONFLICTS) {
      if (!commandNames.includes(commandName)) {
        continue;
      }

      const rewrittenUrl = this.downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

      if (rewrittenUrl === url) {
        log.debug(`Did not know how to rewrite the original URL '${url}' ` + `for ${this.downstreamProtocol} protocol`);
        break;
      }

      log.info(`Rewrote the original URL '${url}' to '${rewrittenUrl}' ` + `for ${this.downstreamProtocol} protocol`);
      return await this.proxyFunc(rewrittenUrl, method, body);
    }

    return await this.proxyFunc(url, method, body);
  }

}

var _default = ProtocolConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJvdG9jb2wtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkNPTU1BTkRfVVJMU19DT05GTElDVFMiLCJjb21tYW5kTmFtZXMiLCJqc29ud3BDb252ZXJ0ZXIiLCJ1cmwiLCJyZXBsYWNlIiwiaW5jbHVkZXMiLCJ3M2NDb252ZXJ0ZXIiLCJ0ZXN0IiwidzNjVXJsIiwidzNjUHJvcGVydHlSZWdleCIsImpzb253cFVybCIsImluZm8iLCJNSlNPTldQIiwiVzNDIiwiUFJPVE9DT0xTIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJjb25zdHJ1Y3RvciIsInByb3h5RnVuYyIsIl9kb3duc3RyZWFtUHJvdG9jb2wiLCJkb3duc3RyZWFtUHJvdG9jb2wiLCJ2YWx1ZSIsImdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyIsImJvZHkiLCJfIiwiaGFzIiwidHlwZVRvVzNDIiwieCIsInR5cGUiLCJtcyIsInR5cGVUb0pTT05XUCIsInRvUGFpcnMiLCJmaWx0ZXIiLCJwYWlyIiwibWFwIiwicHJveHlTZXRUaW1lb3V0cyIsIm1ldGhvZCIsInJlc3BvbnNlIiwicmVzQm9keSIsInRpbWVvdXRSZXF1ZXN0T2JqZWN0cyIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsInRpbWVvdXRPYmoiLCJzdGF0dXNDb2RlIiwicHJveHlTZXRXaW5kb3ciLCJib2R5T2JqIiwidXRpbCIsInNhZmVKc29uUGFyc2UiLCJpc1BsYWluT2JqZWN0IiwibmFtZSIsImhhbmRsZSIsInByb3h5U2V0VmFsdWUiLCJoYXNWYWx1ZSIsInRleHQiLCJpc1N0cmluZyIsImlzQXJyYXkiLCJqb2luIiwiT2JqZWN0IiwiYXNzaWduIiwicHJveHlTZXRGcmFtZSIsImlkIiwiTUpTT05XUF9FTEVNRU5UX0tFWSIsIlczQ19FTEVNRU5UX0tFWSIsInByb3h5UGVyZm9ybUFjdGlvbnMiLCJwcm94eVJlbGVhc2VBY3Rpb25zIiwiY29udmVy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QUFDQyxHQUFELENBREUsR0FFakJHLFlBQVksQ0FBQ0gsR0FBRCxDQUZoQjs7QUFHQSxVQUFJZ0UsWUFBWSxLQUFLaEUsR0FBckIsRUFBMEI7QUFDeEJOLFFBQUFBLEdBQUcsQ0FBQzBDLEtBQUosQ0FBVyxpREFBZ0RwQyxHQUFJLElBQXJELEdBQ1AsT0FBTSxLQUFLZ0Isa0JBQW1CLFdBRGpDO0FBRUE7QUFDRDs7QUFDRHRCLE1BQUFBLEdBQUcsQ0FBQ2MsSUFBSixDQUFVLDZCQUE0QlIsR0FBSSxTQUFRZ0UsWUFBYSxJQUF0RCxHQUNOLE9BQU0sS0FBS2hELGtCQUFtQixXQURqQztBQUVBLGFBQU8sTUFBTSxLQUFLRixTQUFMLENBQWVrRCxZQUFmLEVBQTZCaEMsTUFBN0IsRUFBcUNiLElBQXJDLENBQWI7QUFDRDs7QUFHRCxXQUFPLE1BQU0sS0FBS0wsU0FBTCxDQUFlZCxHQUFmLEVBQW9CZ0MsTUFBcEIsRUFBNEJiLElBQTVCLENBQWI7QUFDRDs7QUFwTXFCOztlQXVNVFAsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyLCB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGR1cGxpY2F0ZUtleXMgfSBmcm9tICcuLi9iYXNlZHJpdmVyL2hlbHBlcnMnO1xuaW1wb3J0IHtcbiAgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZLCBQUk9UT0NPTFNcbn0gZnJvbSAnLi4vY29uc3RhbnRzJztcblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignUHJvdG9jb2wgQ29udmVydGVyJyk7XG5cblxuZXhwb3J0IGNvbnN0IENPTU1BTkRfVVJMU19DT05GTElDVFMgPSBbXG4gIHtcbiAgICBjb21tYW5kTmFtZXM6IFsnZXhlY3V0ZScsICdleGVjdXRlQXN5bmMnXSxcbiAgICBqc29ud3BDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9leGVjdXRlLiovLFxuICAgICAgdXJsLmluY2x1ZGVzKCdhc3luYycpID8gJy9leGVjdXRlX2FzeW5jJyA6ICcvZXhlY3V0ZScpLFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGUvYXN5bmMnIDogJy9leGVjdXRlL3N5bmMnKSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRFbGVtZW50U2NyZWVuc2hvdCddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2VsZW1lbnRcXC8oW14vXSspXFwvc2NyZWVuc2hvdCQvLFxuICAgICAgJy9zY3JlZW5zaG90LyQxJyksXG4gICAgdzNjQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvc2NyZWVuc2hvdFxcLyhbXi9dKykvLFxuICAgICAgJy9lbGVtZW50LyQxL3NjcmVlbnNob3QnKSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRXaW5kb3dIYW5kbGVzJywgJ2dldFdpbmRvd0hhbmRsZSddLFxuICAgIGpzb253cENvbnZlcnRlciAodXJsKSB7XG4gICAgICByZXR1cm4gL1xcL3dpbmRvdyQvLnRlc3QodXJsKVxuICAgICAgICA/IHVybC5yZXBsYWNlKC9cXC93aW5kb3ckLywgJy93aW5kb3dfaGFuZGxlJylcbiAgICAgICAgOiB1cmwucmVwbGFjZSgvXFwvd2luZG93XFwvaGFuZGxlKHM/KSQvLCAnL3dpbmRvd19oYW5kbGUkMScpO1xuICAgIH0sXG4gICAgdzNjQ29udmVydGVyICh1cmwpIHtcbiAgICAgIHJldHVybiAvXFwvd2luZG93X2hhbmRsZSQvLnRlc3QodXJsKVxuICAgICAgICA/IHVybC5yZXBsYWNlKC9cXC93aW5kb3dfaGFuZGxlJC8sICcvd2luZG93JylcbiAgICAgICAgOiB1cmwucmVwbGFjZSgvXFwvd2luZG93X2hhbmRsZXMkLywgJy93aW5kb3cvaGFuZGxlcycpO1xuICAgIH0sXG4gIH0sXG4gIHtcbiAgICBjb21tYW5kTmFtZXM6IFsnZ2V0UHJvcGVydHknXSxcbiAgICBqc29ud3BDb252ZXJ0ZXI6ICh3M2NVcmwpID0+IHtcbiAgICAgIGNvbnN0IHczY1Byb3BlcnR5UmVnZXggPSAvXFwvZWxlbWVudFxcLyhbXi9dKylcXC9wcm9wZXJ0eVxcLyhbXi9dKykvO1xuICAgICAgY29uc3QganNvbndwVXJsID0gdzNjVXJsLnJlcGxhY2UodzNjUHJvcGVydHlSZWdleCwgJy9lbGVtZW50LyQxL2F0dHJpYnV0ZS8kMicpO1xuICAgICAgbG9nLmluZm8oYENvbnZlcnRpbmcgVzNDICcke3czY1VybH0nIHRvICcke2pzb253cFVybH0nYCk7XG4gICAgICByZXR1cm4ganNvbndwVXJsO1xuICAgIH0sXG4gICAgdzNjQ29udmVydGVyOiAoanNvbndwVXJsKSA9PiBqc29ud3BVcmwgLy8gRG9uJ3QgY29udmVydCBKU09OV1AgVVJMIHRvIFczQy4gVzNDIGFjY2VwdHMgL2F0dHJpYnV0ZSBhbmQgL3Byb3BlcnR5XG4gIH1cbl07XG5cbmNvbnN0IHtNSlNPTldQLCBXM0N9ID0gUFJPVE9DT0xTO1xuXG5cbmNsYXNzIFByb3RvY29sQ29udmVydGVyIHtcbiAgY29uc3RydWN0b3IgKHByb3h5RnVuYykge1xuICAgIHRoaXMucHJveHlGdW5jID0gcHJveHlGdW5jO1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IG51bGw7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGRvd25zdHJlYW1Qcm90b2NvbCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBXM0MgL3RpbWVvdXRzIGNhbiB0YWtlIGFzIG1hbnkgYXMgMyB0aW1lb3V0IHR5cGVzIGF0IG9uY2UsIE1KU09OV1AgL3RpbWVvdXRzIG9ubHkgdGFrZXMgb25lXG4gICAqIGF0IGEgdGltZS4gU28gaWYgd2UncmUgdXNpbmcgVzNDIGFuZCBwcm94eWluZyB0byBNSlNPTldQIGFuZCB0aGVyZSdzIG1vcmUgdGhhbiBvbmUgdGltZW91dCB0eXBlXG4gICAqIHByb3ZpZGVkIGluIHRoZSByZXF1ZXN0LCB3ZSBuZWVkIHRvIGRvIDMgcHJveGllcyBhbmQgY29tYmluZSB0aGUgcmVzdWx0XG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBib2R5IFJlcXVlc3QgYm9keVxuICAgKiBAcmV0dXJuIHtBcnJheX0gQXJyYXkgb2YgVzNDICsgTUpTT05XUCBjb21wYXRpYmxlIHRpbWVvdXQgb2JqZWN0c1xuICAgKi9cbiAgZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzIChib2R5KSB7XG4gICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBXM0MgJiYgXy5oYXMoYm9keSwgJ21zJykgJiYgXy5oYXMoYm9keSwgJ3R5cGUnKSkge1xuICAgICAgY29uc3QgdHlwZVRvVzNDID0gKHgpID0+IHggPT09ICdwYWdlIGxvYWQnID8gJ3BhZ2VMb2FkJyA6IHg7XG4gICAgICByZXR1cm4gW3tcbiAgICAgICAgW3R5cGVUb1czQyhib2R5LnR5cGUpXTogYm9keS5tcyxcbiAgICAgIH1dO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUCAmJiAoIV8uaGFzKGJvZHksICdtcycpIHx8ICFfLmhhcyhib2R5LCAndHlwZScpKSkge1xuICAgICAgY29uc3QgdHlwZVRvSlNPTldQID0gKHgpID0+IHggPT09ICdwYWdlTG9hZCcgPyAncGFnZSBsb2FkJyA6IHg7XG4gICAgICByZXR1cm4gXy50b1BhaXJzKGJvZHkpXG4gICAgICAgIC8vIE9ubHkgdHJhbnNmb3JtIHRoZSBlbnRyeSBpZiBtcyB2YWx1ZSBpcyBhIHZhbGlkIHBvc2l0aXZlIGZsb2F0IG51bWJlclxuICAgICAgICAuZmlsdGVyKChwYWlyKSA9PiAvXlxcZCsoPzpbLixdXFxkKj8pPyQvLnRlc3QoYCR7cGFpclsxXX1gKSlcbiAgICAgICAgLm1hcChmdW5jdGlvbiAocGFpcikge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiB0eXBlVG9KU09OV1AocGFpclswXSksXG4gICAgICAgICAgICBtczogcGFpclsxXSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gW2JvZHldO1xuICB9XG5cbiAgLyoqXG4gICAqIFByb3h5IGFuIGFycmF5IG9mIHRpbWVvdXQgb2JqZWN0cyBhbmQgbWVyZ2UgdGhlIHJlc3VsdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIEVuZHBvaW50IHVybFxuICAgKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIEVuZHBvaW50IG1ldGhvZFxuICAgKiBAcGFyYW0ge09iamVjdH0gYm9keSBSZXF1ZXN0IGJvZHlcbiAgICovXG4gIGFzeW5jIHByb3h5U2V0VGltZW91dHMgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgbGV0IHJlc3BvbnNlLCByZXNCb2R5O1xuXG4gICAgY29uc3QgdGltZW91dFJlcXVlc3RPYmplY3RzID0gdGhpcy5nZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMoYm9keSk7XG4gICAgbG9nLmRlYnVnKGBXaWxsIHNlbmQgdGhlIGZvbGxvd2luZyByZXF1ZXN0IGJvZGllcyB0byAvdGltZW91dHM6ICR7SlNPTi5zdHJpbmdpZnkodGltZW91dFJlcXVlc3RPYmplY3RzKX1gKTtcbiAgICBmb3IgKGNvbnN0IHRpbWVvdXRPYmogb2YgdGltZW91dFJlcXVlc3RPYmplY3RzKSB7XG4gICAgICBbcmVzcG9uc2UsIHJlc0JvZHldID0gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIHRpbWVvdXRPYmopO1xuXG4gICAgICAvLyBJZiB3ZSBnb3QgYSBub24tTUpTT05XUCByZXNwb25zZSwgcmV0dXJuIHRoZSByZXN1bHQsIG5vdGhpbmcgbGVmdCB0byBkb1xuICAgICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sICE9PSBNSlNPTldQKSB7XG4gICAgICAgIHJldHVybiBbcmVzcG9uc2UsIHJlc0JvZHldO1xuICAgICAgfVxuXG4gICAgICAvLyBJZiB3ZSBnb3QgYW4gZXJyb3IsIHJldHVybiB0aGUgZXJyb3IgcmlnaHQgYXdheVxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gNDAwKSB7XG4gICAgICAgIHJldHVybiBbcmVzcG9uc2UsIHJlc0JvZHldO1xuICAgICAgfVxuXG4gICAgICAvLyAuLi5PdGhlcndpc2UsIGNvbnRpbnVlIHRvIHRoZSBuZXh0IHRpbWVvdXRzIGNhbGxcbiAgICB9XG4gICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gIH1cblxuICBhc3luYyBwcm94eVNldFdpbmRvdyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBjb25zdCBib2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYm9keU9iaikpIHtcbiAgICAgIGlmICh0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gVzNDICYmIF8uaGFzKGJvZHlPYmosICduYW1lJykgJiYgIV8uaGFzKGJvZHlPYmosICdoYW5kbGUnKSkge1xuICAgICAgICBsb2cuZGVidWcoYENvcGllZCAnbmFtZScgdmFsdWUgJyR7Ym9keU9iai5uYW1lfScgdG8gJ2hhbmRsZScgYXMgcGVyIFczQyBzcGVjYCk7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwge1xuICAgICAgICAgIC4uLmJvZHlPYmosXG4gICAgICAgICAgaGFuZGxlOiBib2R5T2JqLm5hbWUsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQICYmIF8uaGFzKGJvZHlPYmosICdoYW5kbGUnKSAmJiAhXy5oYXMoYm9keU9iaiwgJ25hbWUnKSkge1xuICAgICAgICBsb2cuZGVidWcoYENvcGllZCAnaGFuZGxlJyB2YWx1ZSAnJHtib2R5T2JqLmhhbmRsZX0nIHRvICduYW1lJyBhcyBwZXIgSlNPTldQIHNwZWNgKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCB7XG4gICAgICAgICAgLi4uYm9keU9iaixcbiAgICAgICAgICBuYW1lOiBib2R5T2JqLmhhbmRsZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5U2V0VmFsdWUgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgY29uc3QgYm9keU9iaiA9IHV0aWwuc2FmZUpzb25QYXJzZShib2R5KTtcbiAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGJvZHlPYmopICYmICh1dGlsLmhhc1ZhbHVlKGJvZHlPYmoudGV4dCkgfHwgdXRpbC5oYXNWYWx1ZShib2R5T2JqLnZhbHVlKSkpIHtcbiAgICAgIGxldCB7dGV4dCwgdmFsdWV9ID0gYm9keU9iajtcbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKHRleHQpICYmICF1dGlsLmhhc1ZhbHVlKHZhbHVlKSkge1xuICAgICAgICB2YWx1ZSA9IF8uaXNTdHJpbmcodGV4dClcbiAgICAgICAgICA/IFsuLi50ZXh0XVxuICAgICAgICAgIDogKF8uaXNBcnJheSh0ZXh0KSA/IHRleHQgOiBbXSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQWRkZWQgJ3ZhbHVlJyBwcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX0gdG8gJ3NldFZhbHVlJyByZXF1ZXN0IGJvZHlgKTtcbiAgICAgIH0gZWxzZSBpZiAoIXV0aWwuaGFzVmFsdWUodGV4dCkgJiYgdXRpbC5oYXNWYWx1ZSh2YWx1ZSkpIHtcbiAgICAgICAgdGV4dCA9IF8uaXNBcnJheSh2YWx1ZSlcbiAgICAgICAgICA/IHZhbHVlLmpvaW4oJycpXG4gICAgICAgICAgOiAoXy5pc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZSA6ICcnKTtcbiAgICAgICAgbG9nLmRlYnVnKGBBZGRlZCAndGV4dCcgcHJvcGVydHkgJHtKU09OLnN0cmluZ2lmeSh0ZXh0KX0gdG8gJ3NldFZhbHVlJyByZXF1ZXN0IGJvZHlgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgT2JqZWN0LmFzc2lnbih7fSwgYm9keU9iaiwge1xuICAgICAgICB0ZXh0LFxuICAgICAgICB2YWx1ZSxcbiAgICAgIH0pKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgcHJveHlTZXRGcmFtZSAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBjb25zdCBib2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIHJldHVybiBfLmhhcyhib2R5T2JqLCAnaWQnKSAmJiBfLmlzUGxhaW5PYmplY3QoYm9keU9iai5pZClcbiAgICAgID8gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIHtcbiAgICAgICAgLi4uYm9keU9iaixcbiAgICAgICAgaWQ6IGR1cGxpY2F0ZUtleXMoYm9keU9iai5pZCwgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZKSxcbiAgICAgIH0pXG4gICAgICA6IGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UGVyZm9ybUFjdGlvbnMgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgY29uc3QgYm9keU9iaiA9IHV0aWwuc2FmZUpzb25QYXJzZShib2R5KTtcbiAgICByZXR1cm4gXy5pc1BsYWluT2JqZWN0KGJvZHlPYmopXG4gICAgICA/IGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBkdXBsaWNhdGVLZXlzKGJvZHlPYmosIE1KU09OV1BfRUxFTUVOVF9LRVksIFczQ19FTEVNRU5UX0tFWSkpXG4gICAgICA6IGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVsZWFzZUFjdGlvbnMgKHVybCwgbWV0aG9kKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgXCJjcm9zc2luZ1wiIGVuZHBvaW50cyBmb3IgdGhlIGNhc2VcbiAgICogd2hlbiB1cHN0cmVhbSBhbmQgZG93bnN0cmVhbSBkcml2ZXJzIG9wZXJhdGUgZGlmZmVyZW50IHByb3RvY29sc1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29tbWFuZE5hbWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVybFxuICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kXG4gICAqIEBwYXJhbSB7P3N0cmluZ3xvYmplY3R9IGJvZHlcbiAgICogQHJldHVybnMgVGhlIHByb3h5ZnlpbmcgcmVzdWx0IGFzIFtyZXNwb25zZSwgcmVzcG9uc2VCb2R5XSB0dXBsZVxuICAgKi9cbiAgYXN5bmMgY29udmVydEFuZFByb3h5IChjb21tYW5kTmFtZSwgdXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBpZiAoIXRoaXMuZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cblxuICAgIC8vIFNhbWUgdXJsLCBidXQgZGlmZmVyZW50IGFyZ3VtZW50c1xuICAgIHN3aXRjaCAoY29tbWFuZE5hbWUpIHtcbiAgICAgIGNhc2UgJ3RpbWVvdXRzJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlTZXRUaW1lb3V0cyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBjYXNlICdzZXRXaW5kb3cnOlxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eVNldFdpbmRvdyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBjYXNlICdzZXRWYWx1ZSc6XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5U2V0VmFsdWUodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgICAgY2FzZSAncGVyZm9ybUFjdGlvbnMnOlxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eVBlcmZvcm1BY3Rpb25zKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICAgIGNhc2UgJ3JlbGVhc2VBY3Rpb25zJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlSZWxlYXNlQWN0aW9ucyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBjYXNlICdzZXRGcmFtZSc6XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5U2V0RnJhbWUodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgLy8gU2FtZSBhcmd1bWVudHMsIGJ1dCBkaWZmZXJlbnQgVVJMc1xuICAgIGZvciAoY29uc3Qge2NvbW1hbmROYW1lcywganNvbndwQ29udmVydGVyLCB3M2NDb252ZXJ0ZXJ9IG9mIENPTU1BTkRfVVJMU19DT05GTElDVFMpIHtcbiAgICAgIGlmICghY29tbWFuZE5hbWVzLmluY2x1ZGVzKGNvbW1hbmROYW1lKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmV3cml0dGVuVXJsID0gdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1BcbiAgICAgICAgPyBqc29ud3BDb252ZXJ0ZXIodXJsKVxuICAgICAgICA6IHczY0NvbnZlcnRlcih1cmwpO1xuICAgICAgaWYgKHJld3JpdHRlblVybCA9PT0gdXJsKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRGlkIG5vdCBrbm93IGhvdyB0byByZXdyaXRlIHRoZSBvcmlnaW5hbCBVUkwgJyR7dXJsfScgYCArXG4gICAgICAgICAgYGZvciAke3RoaXMuZG93bnN0cmVhbVByb3RvY29sfSBwcm90b2NvbGApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGxvZy5pbmZvKGBSZXdyb3RlIHRoZSBvcmlnaW5hbCBVUkwgJyR7dXJsfScgdG8gJyR7cmV3cml0dGVuVXJsfScgYCArXG4gICAgICAgIGBmb3IgJHt0aGlzLmRvd25zdHJlYW1Qcm90b2NvbH0gcHJvdG9jb2xgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyhyZXdyaXR0ZW5VcmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuXG4gICAgLy8gTm8gbWF0Y2hlcyBmb3VuZC4gUHJvY2VlZCBub3JtYWxseVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHJvdG9jb2xDb252ZXJ0ZXI7XG4iXSwiZmlsZSI6ImxpYi9qc29ud3AtcHJveHkvcHJvdG9jb2wtY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
