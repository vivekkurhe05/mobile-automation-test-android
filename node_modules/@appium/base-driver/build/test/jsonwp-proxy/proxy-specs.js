"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lib = require("../../lib");

var _mockRequest = _interopRequireDefault(require("./mock-request"));

var _errors = require("../../lib/protocol/errors");

var _helpers = require("../helpers");

function buildReqRes(url, method, body) {
  let req = {
    originalUrl: url,
    method,
    body
  };
  let res = {};
  res.headers = {};

  res.set = (k, v) => {
    res[k] = v;
  };

  res.status = code => {
    res.sentCode = code;
    return res;
  };

  res.send = body => {
    try {
      body = JSON.parse(body);
    } catch (e) {}

    res.sentBody = body;
  };

  return [req, res];
}

describe('proxy', function () {
  let port;

  function mockProxy(opts = {}) {
    opts = {
      server: _helpers.TEST_HOST,
      port,
      ...opts
    };
    let proxy = new _lib.JWProxy(opts);

    proxy.request = async function (...args) {
      return await (0, _mockRequest.default)(...args);
    };

    return proxy;
  }

  before(async function () {
    port = await (0, _helpers.getTestPort)();
  });
  it('should override default params', function () {
    let j = mockProxy({
      server: '127.0.0.2',
      port
    });
    j.server.should.equal('127.0.0.2');
    j.port.should.equal(port);
  });
  it('should save session id on session creation', async function () {
    let j = mockProxy();
    let [res, body] = await j.proxy('/session', 'POST', {
      desiredCapabilities: {}
    });
    res.statusCode.should.equal(200);
    body.should.eql({
      status: 0,
      sessionId: '123',
      value: {
        browserName: 'boo'
      }
    });
    j.sessionId.should.equal('123');
  });
  describe('getUrlForProxy', function () {
    it('should modify session id, host, and port', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.getUrlForProxy('http://host.com:1234/session/456/element/200/value').should.eql(`http://${_helpers.TEST_HOST}:${port}/session/123/element/200/value`);
    });
    it('should prepend scheme, host and port if not provided', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.getUrlForProxy('/session/456/element/200/value').should.eql(`http://${_helpers.TEST_HOST}:${port}/session/123/element/200/value`);
    });
    it('should respect nonstandard incoming request base path', function () {
      let j = mockProxy({
        sessionId: '123',
        reqBasePath: ''
      });
      j.getUrlForProxy('/session/456/element/200/value').should.eql(`http://${_helpers.TEST_HOST}:${port}/session/123/element/200/value`);
      j = mockProxy({
        sessionId: '123',
        reqBasePath: '/my/base/path'
      });
      j.getUrlForProxy('/my/base/path/session/456/element/200/value').should.eql(`http://${_helpers.TEST_HOST}:${port}/session/123/element/200/value`);
    });
    it('should work with urls which do not have session ids', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.getUrlForProxy('http://host.com:1234/session').should.eql(`http://${_helpers.TEST_HOST}:${port}/session`);
      let newUrl = j.getUrlForProxy('/session');
      newUrl.should.eql(`http://${_helpers.TEST_HOST}:${port}/session`);
    });
    it('should throw an error if url requires a sessionId but its null', function () {
      let j = mockProxy();
      let e;

      try {
        j.getUrlForProxy('/session/456/element/200/value');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.message.should.contain('without session id');
    });
    it('should not throw an error if url does not require a session id and its null', function () {
      let j = mockProxy();
      let newUrl = j.getUrlForProxy('/status');
      should.exist(newUrl);
    });
  });
  describe('straight proxy', function () {
    it('should successfully proxy straight', async function () {
      let j = mockProxy();
      let [res, body] = await j.proxy('/status', 'GET');
      res.statusCode.should.equal(200);
      body.should.eql({
        status: 0,
        value: {
          foo: 'bar'
        }
      });
    });
    it('should pass along request errors', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.proxy('/badurl', 'GET').should.eventually.be.rejectedWith('Could not proxy');
    });
    it('should proxy error responses and codes', async function () {
      let j = mockProxy({
        sessionId: '123'
      });

      try {
        await j.proxy('/element/bad/text', 'GET');
      } catch (e) {
        (0, _errors.isErrorType)(e.getActualError(), _errors.errors.ElementNotVisibleError).should.be.true;
      }
    });
  });
  describe('command proxy', function () {
    it('should successfully proxy command', async function () {
      let j = mockProxy();
      let res = await j.command('/status', 'GET');
      res.should.eql({
        foo: 'bar'
      });
    });
    it('should pass along request errors', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.command('/badurl', 'GET').should.eventually.be.rejectedWith('Could not proxy');
    });
    it('should throw when a command fails', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let e = null;

      try {
        await j.command('/element/bad/text', 'GET');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.message.should.contain('Invisible element');
    });
    it('should throw when a command fails with a 200 because the status is not 0', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let e = null;

      try {
        await j.command('/element/200/text', 'GET');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.error.should.eql('element not visible');
    });
    it('should throw when a command fails with a 100', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let e = null;

      try {
        await j.command('/session/badchrome/nochrome', 'GET');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.message.should.contain('chrome not reachable');
    });
  });
  describe('req/res proxy', function () {
    it('should successfully proxy via req and send to res', async function () {
      let j = mockProxy();
      let [req, res] = buildReqRes('/status', 'GET');
      await j.proxyReqRes(req, res);
      res.headers['content-type'].should.equal('application/json; charset=utf-8');
      res.sentCode.should.equal(200);
      res.sentBody.should.eql({
        value: {
          foo: 'bar'
        }
      });
    });
    it('should rewrite the inner session id so it doesnt change', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/element/200/value', 'GET');
      await j.proxyReqRes(req, res);
      res.sentBody.should.eql({
        value: 'foobar',
        sessionId: '123'
      });
    });
    it('should rewrite the inner session id with sessionId in url', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/session/456/element/200/value', 'POST');
      await j.proxyReqRes(req, res);
      res.sentBody.should.eql({
        value: 'foobar',
        sessionId: '456'
      });
    });
    it('should pass through urls that do not require session IDs', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/status', 'GET');
      await j.proxyReqRes(req, res);
      res.sentBody.should.eql({
        value: {
          'foo': 'bar'
        }
      });
    });
    it('should proxy strange responses', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/nochrome', 'GET');
      await j.proxyReqRes(req, res);
      res.sentCode.should.equal(100);
      res.sentBody.should.eql({
        value: {
          message: 'chrome not reachable'
        }
      });
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvanNvbndwLXByb3h5L3Byb3h5LXNwZWNzLmpzIl0sIm5hbWVzIjpbImJ1aWxkUmVxUmVzIiwidXJsIiwibWV0aG9kIiwiYm9keSIsInJlcSIsIm9yaWdpbmFsVXJsIiwicmVzIiwiaGVhZGVycyIsInNldCIsImsiLCJ2Iiwic3RhdHVzIiwiY29kZSIsInNlbnRDb2RlIiwic2VuZCIsIkpTT04iLCJwYXJzZSIsImUiLCJzZW50Qm9keSIsImRlc2NyaWJlIiwicG9ydCIsIm1vY2tQcm94eSIsIm9wdHMiLCJzZXJ2ZXIiLCJURVNUX0hPU1QiLCJwcm94eSIsIkpXUHJveHkiLCJyZXF1ZXN0IiwiYXJncyIsImJlZm9yZSIsIml0IiwiaiIsInNob3VsZCIsImVxdWFsIiwiZGVzaXJlZENhcGFiaWxpdGllcyIsInN0YXR1c0NvZGUiLCJlcWwiLCJzZXNzaW9uSWQiLCJ2YWx1ZSIsImJyb3dzZXJOYW1lIiwiZ2V0VXJsRm9yUHJveHkiLCJyZXFCYXNlUGF0aCIsIm5ld1VybCIsImVyciIsImV4aXN0IiwibWVzc2FnZSIsImNvbnRhaW4iLCJmb28iLCJldmVudHVhbGx5IiwiYmUiLCJyZWplY3RlZFdpdGgiLCJnZXRBY3R1YWxFcnJvciIsImVycm9ycyIsIkVsZW1lbnROb3RWaXNpYmxlRXJyb3IiLCJ0cnVlIiwiY29tbWFuZCIsImVycm9yIiwicHJveHlSZXFSZXMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLFNBQVNBLFdBQVQsQ0FBc0JDLEdBQXRCLEVBQTJCQyxNQUEzQixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDdkMsTUFBSUMsR0FBRyxHQUFHO0FBQUNDLElBQUFBLFdBQVcsRUFBRUosR0FBZDtBQUFtQkMsSUFBQUEsTUFBbkI7QUFBMkJDLElBQUFBO0FBQTNCLEdBQVY7QUFDQSxNQUFJRyxHQUFHLEdBQUcsRUFBVjtBQUNBQSxFQUFBQSxHQUFHLENBQUNDLE9BQUosR0FBYyxFQUFkOztBQUNBRCxFQUFBQSxH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QUFGLENBQWNyRCxHQUFkLEVBQW1CRSxHQUFuQixDQUFOO0FBQ0FBLE1BQUFBLEdBQUcsQ0FBQ08sUUFBSixDQUFhbUIsTUFBYixDQUFvQkMsS0FBcEIsQ0FBMEIsR0FBMUI7QUFDQTNCLE1BQUFBLEdBQUcsQ0FBQ1ksUUFBSixDQUFhYyxNQUFiLENBQW9CSSxHQUFwQixDQUF3QjtBQUFDRSxRQUFBQSxLQUFLLEVBQUU7QUFBQ08sVUFBQUEsT0FBTyxFQUFFO0FBQVY7QUFBUixPQUF4QjtBQUNELEtBTkMsQ0FBRjtBQU9ELEdBbENPLENBQVI7QUFtQ0QsQ0E5S08sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJy4vbW9jay1yZXF1ZXN0JztcbmltcG9ydCB7IGlzRXJyb3JUeXBlLCBlcnJvcnMgfSBmcm9tICcuLi8uLi9saWIvcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCB7IGdldFRlc3RQb3J0LCBURVNUX0hPU1QgfSBmcm9tICcuLi9oZWxwZXJzJztcblxuZnVuY3Rpb24gYnVpbGRSZXFSZXMgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gIGxldCByZXEgPSB7b3JpZ2luYWxVcmw6IHVybCwgbWV0aG9kLCBib2R5fTtcbiAgbGV0IHJlcyA9IHt9O1xuICByZXMuaGVhZGVycyA9IHt9O1xuICByZXMuc2V0ID0gKGssIHYpID0+IHsgcmVzW2tdID0gdjsgfTtcbiAgcmVzLnN0YXR1cyA9IChjb2RlKSA9PiB7XG4gICAgcmVzLnNlbnRDb2RlID0gY29kZTtcbiAgICByZXR1cm4gcmVzO1xuICB9O1xuICByZXMuc2VuZCA9IChib2R5KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgIH0gY2F0Y2ggKGUpIHt9XG4gICAgcmVzLnNlbnRCb2R5ID0gYm9keTtcbiAgfTtcbiAgcmV0dXJuIFtyZXEsIHJlc107XG59XG5cbmRlc2NyaWJlKCdwcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgbGV0IHBvcnQ7XG5cbiAgZnVuY3Rpb24gbW9ja1Byb3h5IChvcHRzID0ge30pIHtcbiAgICAvLyBzZXRzIGRlZmF1bHQgc2VydmVyL3BvcnRcbiAgICBvcHRzID0ge3NlcnZlcjogVEVTVF9IT1NULCBwb3J0LCAuLi5vcHRzfTtcbiAgICBsZXQgcHJveHkgPSBuZXcgSldQcm94eShvcHRzKTtcbiAgICBwcm94eS5yZXF1ZXN0ID0gYXN5bmMgZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICAgIHJldHVybiBhd2FpdCByZXF1ZXN0KC4uLmFyZ3MpO1xuICAgIH07XG4gICAgcmV0dXJuIHByb3h5O1xuICB9XG5cbiAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBwb3J0ID0gYXdhaXQgZ2V0VGVzdFBvcnQoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBvdmVycmlkZSBkZWZhdWx0IHBhcmFtcycsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2VydmVyOiAnMTI3LjAuMC4yJywgcG9ydH0pO1xuICAgIGouc2VydmVyLnNob3VsZC5lcXVhbCgnMTI3LjAuMC4yJyk7XG4gICAgai5wb3J0LnNob3VsZC5lcXVhbChwb3J0KTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc2F2ZSBzZXNzaW9uIGlkIG9uIHNlc3Npb24gY3JlYXRpb24nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGogPSBtb2NrUHJveHkoKTtcbiAgICBsZXQgW3JlcywgYm9keV0gPSBhd2FpdCBqLnByb3h5KCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IHt9fSk7XG4gICAgcmVzLnN0YXR1c0NvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgYm9keS5zaG91bGQuZXFsKHtzdGF0dXM6IDAsIHNlc3Npb25JZDogJzEyMycsIHZhbHVlOiB7YnJvd3Nlck5hbWU6ICdib28nfX0pO1xuICAgIGouc2Vzc2lvbklkLnNob3VsZC5lcXVhbCgnMTIzJyk7XG4gIH0pO1xuICBkZXNjcmliZSgnZ2V0VXJsRm9yUHJveHknLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBtb2RpZnkgc2Vzc2lvbiBpZCwgaG9zdCwgYW5kIHBvcnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgai5nZXRVcmxGb3JQcm94eSgnaHR0cDovL2hvc3QuY29tOjEyMzQvc2Vzc2lvbi80NTYvZWxlbWVudC8yMDAvdmFsdWUnKVxuICAgICAgIC5zaG91bGQuZXFsKGBodHRwOi8vJHtURVNUX0hPU1R9OiR7cG9ydH0vc2Vzc2lvbi8xMjMvZWxlbWVudC8yMDAvdmFsdWVgKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHByZXBlbmQgc2NoZW1lLCBob3N0IGFuZCBwb3J0IGlmIG5vdCBwcm92aWRlZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnfSk7XG4gICAgICBqLmdldFVybEZvclByb3h5KCcvc2Vzc2lvbi80NTYvZWxlbWVudC8yMDAvdmFsdWUnKVxuICAgICAgIC5zaG91bGQuZXFsKGBodHRwOi8vJHtURVNUX0hPU1R9OiR7cG9ydH0vc2Vzc2lvbi8xMjMvZWxlbWVudC8yMDAvdmFsdWVgKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHJlc3BlY3Qgbm9uc3RhbmRhcmQgaW5jb21pbmcgcmVxdWVzdCBiYXNlIHBhdGgnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJywgcmVxQmFzZVBhdGg6ICcnfSk7XG4gICAgICBqLmdldFVybEZvclByb3h5KCcvc2Vzc2lvbi80NTYvZWxlbWVudC8yMDAvdmFsdWUnKVxuICAgICAgIC5zaG91bGQuZXFsKGBodHRwOi8vJHtURVNUX0hPU1R9OiR7cG9ydH0vc2Vzc2lvbi8xMjMvZWxlbWVudC8yMDAvdmFsdWVgKTtcblxuICAgICAgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJywgcmVxQmFzZVBhdGg6ICcvbXkvYmFzZS9wYXRoJ30pO1xuICAgICAgai5nZXRVcmxGb3JQcm94eSgnL215L2Jhc2UvcGF0aC9zZXNzaW9uLzQ1Ni9lbGVtZW50LzIwMC92YWx1ZScpXG4gICAgICAgLnNob3VsZC5lcWwoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHtwb3J0fS9zZXNzaW9uLzEyMy9lbGVtZW50LzIwMC92YWx1ZWApO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIHVybHMgd2hpY2ggZG8gbm90IGhhdmUgc2Vzc2lvbiBpZHMnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgai5nZXRVcmxGb3JQcm94eSgnaHR0cDovL2hvc3QuY29tOjEyMzQvc2Vzc2lvbicpXG4gICAgICAgLnNob3VsZC5lcWwoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHtwb3J0fS9zZXNzaW9uYCk7XG5cbiAgICAgIGxldCBuZXdVcmwgPSBqLmdldFVybEZvclByb3h5KCcvc2Vzc2lvbicpO1xuICAgICAgbmV3VXJsLnNob3VsZC5lcWwoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHtwb3J0fS9zZXNzaW9uYCk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBpZiB1cmwgcmVxdWlyZXMgYSBzZXNzaW9uSWQgYnV0IGl0cyBudWxsJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoKTtcbiAgICAgIGxldCBlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgai5nZXRVcmxGb3JQcm94eSgnL3Nlc3Npb24vNDU2L2VsZW1lbnQvMjAwL3ZhbHVlJyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZSA9IGVycjtcbiAgICAgIH1cbiAgICAgIHNob3VsZC5leGlzdChlKTtcbiAgICAgIGUubWVzc2FnZS5zaG91bGQuY29udGFpbignd2l0aG91dCBzZXNzaW9uIGlkJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3QgdGhyb3cgYW4gZXJyb3IgaWYgdXJsIGRvZXMgbm90IHJlcXVpcmUgYSBzZXNzaW9uIGlkIGFuZCBpdHMgbnVsbCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KCk7XG4gICAgICBsZXQgbmV3VXJsID0gai5nZXRVcmxGb3JQcm94eSgnL3N0YXR1cycpO1xuXG4gICAgICBzaG91bGQuZXhpc3QobmV3VXJsKTtcbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKCdzdHJhaWdodCBwcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBwcm94eSBzdHJhaWdodCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KCk7XG4gICAgICBsZXQgW3JlcywgYm9keV0gPSBhd2FpdCBqLnByb3h5KCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgcmVzLnN0YXR1c0NvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgICBib2R5LnNob3VsZC5lcWwoe3N0YXR1czogMCwgdmFsdWU6IHtmb286ICdiYXInfX0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcGFzcyBhbG9uZyByZXF1ZXN0IGVycm9ycycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnfSk7XG4gICAgICBqLnByb3h5KCcvYmFkdXJsJywgJ0dFVCcpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgnQ291bGQgbm90IHByb3h5Jyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSBlcnJvciByZXNwb25zZXMgYW5kIGNvZGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGoucHJveHkoJy9lbGVtZW50L2JhZC90ZXh0JywgJ0dFVCcpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpc0Vycm9yVHlwZShlLmdldEFjdHVhbEVycm9yKCksIGVycm9ycy5FbGVtZW50Tm90VmlzaWJsZUVycm9yKS5zaG91bGQuYmUudHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKCdjb21tYW5kIHByb3h5JywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IHByb3h5IGNvbW1hbmQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSgpO1xuICAgICAgbGV0IHJlcyA9IGF3YWl0IGouY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIHJlcy5zaG91bGQuZXFsKHtmb286ICdiYXInfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwYXNzIGFsb25nIHJlcXVlc3QgZXJyb3JzJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGouY29tbWFuZCgnL2JhZHVybCcsICdHRVQnKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoJ0NvdWxkIG5vdCBwcm94eScpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgd2hlbiBhIGNvbW1hbmQgZmFpbHMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IGUgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgai5jb21tYW5kKCcvZWxlbWVudC9iYWQvdGV4dCcsICdHRVQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlID0gZXJyO1xuICAgICAgfVxuICAgICAgc2hvdWxkLmV4aXN0KGUpO1xuICAgICAgZS5tZXNzYWdlLnNob3VsZC5jb250YWluKCdJbnZpc2libGUgZWxlbWVudCcpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgd2hlbiBhIGNvbW1hbmQgZmFpbHMgd2l0aCBhIDIwMCBiZWNhdXNlIHRoZSBzdGF0dXMgaXMgbm90IDAnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IGUgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgai5jb21tYW5kKCcvZWxlbWVudC8yMDAvdGV4dCcsICdHRVQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlID0gZXJyO1xuICAgICAgfVxuICAgICAgc2hvdWxkLmV4aXN0KGUpO1xuICAgICAgZS5lcnJvci5zaG91bGQuZXFsKCdlbGVtZW50IG5vdCB2aXNpYmxlJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0aHJvdyB3aGVuIGEgY29tbWFuZCBmYWlscyB3aXRoIGEgMTAwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGxldCBlID0gbnVsbDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGouY29tbWFuZCgnL3Nlc3Npb24vYmFkY2hyb21lL25vY2hyb21lJywgJ0dFVCcpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGUgPSBlcnI7XG4gICAgICB9XG4gICAgICBzaG91bGQuZXhpc3QoZSk7XG4gICAgICBlLm1lc3NhZ2Uuc2hvdWxkLmNvbnRhaW4oJ2Nocm9tZSBub3QgcmVhY2hhYmxlJyk7XG4gICAgfSk7XG4gIH0pO1xuICBkZXNjcmliZSgncmVxL3JlcyBwcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBwcm94eSB2aWEgcmVxIGFuZCBzZW5kIHRvIHJlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KCk7XG4gICAgICBsZXQgW3JlcSwgcmVzXSA9IGJ1aWxkUmVxUmVzKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgYXdhaXQgai5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gICAgICByZXMuaGVhZGVyc1snY29udGVudC10eXBlJ10uc2hvdWxkLmVxdWFsKCdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04Jyk7XG4gICAgICByZXMuc2VudENvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgICByZXMuc2VudEJvZHkuc2hvdWxkLmVxbCh7dmFsdWU6IHtmb286ICdiYXInfX0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmV3cml0ZSB0aGUgaW5uZXIgc2Vzc2lvbiBpZCBzbyBpdCBkb2VzbnQgY2hhbmdlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGxldCBbcmVxLCByZXNdID0gYnVpbGRSZXFSZXMoJy9lbGVtZW50LzIwMC92YWx1ZScsICdHRVQnKTtcbiAgICAgIGF3YWl0IGoucHJveHlSZXFSZXMocmVxLCByZXMpO1xuICAgICAgcmVzLnNlbnRCb2R5LnNob3VsZC5lcWwoe3ZhbHVlOiAnZm9vYmFyJywgc2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmV3cml0ZSB0aGUgaW5uZXIgc2Vzc2lvbiBpZCB3aXRoIHNlc3Npb25JZCBpbiB1cmwnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IFtyZXEsIHJlc10gPSBidWlsZFJlcVJlcygnL3Nlc3Npb24vNDU2L2VsZW1lbnQvMjAwL3ZhbHVlJywgJ1BPU1QnKTtcbiAgICAgIGF3YWl0IGoucHJveHlSZXFSZXMocmVxLCByZXMpO1xuICAgICAgcmVzLnNlbnRCb2R5LnNob3VsZC5lcWwoe3ZhbHVlOiAnZm9vYmFyJywgc2Vzc2lvbklkOiAnNDU2J30pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcGFzcyB0aHJvdWdoIHVybHMgdGhhdCBkbyBub3QgcmVxdWlyZSBzZXNzaW9uIElEcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnfSk7XG4gICAgICBsZXQgW3JlcSwgcmVzXSA9IGJ1aWxkUmVxUmVzKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgYXdhaXQgai5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gICAgICByZXMuc2VudEJvZHkuc2hvdWxkLmVxbCh7dmFsdWU6IHsnZm9vJzogJ2Jhcid9fSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSBzdHJhbmdlIHJlc3BvbnNlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnfSk7XG4gICAgICBsZXQgW3JlcSwgcmVzXSA9IGJ1aWxkUmVxUmVzKCcvbm9jaHJvbWUnLCAnR0VUJyk7XG4gICAgICBhd2FpdCBqLnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgICAgIHJlcy5zZW50Q29kZS5zaG91bGQuZXF1YWwoMTAwKTtcbiAgICAgIHJlcy5zZW50Qm9keS5zaG91bGQuZXFsKHt2YWx1ZToge21lc3NhZ2U6ICdjaHJvbWUgbm90IHJlYWNoYWJsZSd9fSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwiZmlsZSI6InRlc3QvanNvbndwLXByb3h5L3Byb3h5LXNwZWNzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
