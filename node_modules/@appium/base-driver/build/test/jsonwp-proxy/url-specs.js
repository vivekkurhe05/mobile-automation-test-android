"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lib = require("../../lib");

var _helpers = require("../helpers");

var _lodash = _interopRequireDefault(require("lodash"));

describe('JWProxy', function () {
  let port;
  let createTestURL;
  let testStatusURL;
  let createTestSessionURL;
  let testNewSessionURL;
  const PROXY_HOST = '127.0.0.2';
  const PROXY_PORT = 4723;
  const createProxyURL = (0, _helpers.createAppiumURL)(PROXY_HOST, PROXY_PORT);
  const PROXY_STATUS_URL = createProxyURL('', 'status');

  function createJWProxy(opts = {}) {
    return new _lib.JWProxy({
      server: _helpers.TEST_HOST,
      port,
      ...opts
    });
  }

  before(async function () {
    port = await (0, _helpers.getTestPort)();
    createTestURL = (0, _helpers.createAppiumURL)(_helpers.TEST_HOST, port);
    testStatusURL = createTestURL('', 'status');
    createTestSessionURL = createTestURL(_lodash.default, '');
    testNewSessionURL = createTestURL('', 'session');
  });
  describe('proxying full urls', function () {
    it('should translate host and port', function () {
      let incomingUrl = PROXY_STATUS_URL;
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testStatusURL);
    });
    it('should translate the scheme', function () {
      let incomingUrl = PROXY_STATUS_URL;
      let j = createJWProxy({
        scheme: 'HTTPS'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal((0, _helpers.createAppiumURL)(`https://${_helpers.TEST_HOST}`, port, '', 'status'));
    });
    it('should translate the base', function () {
      let incomingUrl = PROXY_STATUS_URL;
      let j = createJWProxy({
        base: ''
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testStatusURL);
    });
    it('should translate the session id', function () {
      let incomingUrl = createProxyURL('foobar', 'element');
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'element'));
    });
    it('should error when translating session commands without session id', function () {
      let incomingUrl = createProxyURL('foobar', 'element');
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
    });
  });
  describe('proxying partial urls', function () {
    it('should proxy /status', function () {
      let incomingUrl = '/status';
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testStatusURL);
    });
    it('should proxy /session', function () {
      let incomingUrl = '/session';
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testNewSessionURL);
    });
    it('should proxy /sessions', function () {
      let incomingUrl = '/sessions';
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('', 'sessions'));
    });
    it('should proxy session commands based off /session', function () {
      let incomingUrl = '/session/foobar/element';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'element'));
    });
    it('should error session commands based off /session without session id', function () {
      let incomingUrl = '/session/foobar/element';
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
    });
    it('should proxy session commands based off ', function () {
      let incomingUrl = '/session/3d001db2-7987-42a7-975d-8d5d5304083f/timeouts/implicit_wait';
      let j = createJWProxy({
        sessionId: '123'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('123', 'timeouts/implicit_wait'));
    });
    it('should proxy session commands based off /session as ""', function () {
      let incomingUrl = '';
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
      j = createJWProxy({
        sessionId: '123'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestSessionURL('123'));
    });
    it('should proxy session commands without /session', function () {
      let incomingUrl = '/element';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'element'));
    });
    it(`should proxy session commands when '/session' is in the url`, function () {
      let incomingUrl = '/session/82a9b7da-faaf-4a1d-8ef3-5e4fb5812200/cookie/session-something-or-other';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'cookie/session-something-or-other'));
    });
    it(`should proxy session commands when '/session' is in the url and not base on the original url`, function () {
      let incomingUrl = '/session/82a9b7da-faaf-4a1d-8ef3-5e4fb5812200/cookie/session-something-or-other';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'cookie/session-something-or-other'));
    });
    it('should error session commands without /session without session id', function () {
      let incomingUrl = '/element';
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvanNvbndwLXByb3h5L3VybC1zcGVjcy5qcyJdLCJuYW1lcyI6WyJkZXNjcmliZSIsInBvcnQiLCJjcmVhdGVUZXN0VVJMIiwidGVzdFN0YXR1c1VSTCIsImNyZWF0ZVRlc3RTZXNzaW9uVVJMIiwidGVzdE5ld1Nlc3Npb25VUkwiLCJQUk9YWV9IT1NUIiwiUFJPWFlfUE9SVCIsImNyZWF0ZVByb3h5VVJMIiwiUFJPWFlfU1RBVFVTX1VSTCIsImNyZWF0ZUpXUHJveHkiLCJvcHRzIiwiSldQcm94eSIsInNlcnZlciIsIlRFU1RfSE9TVCIsImJlZm9yZSIsIl8iLCJpdCIsImluY29taW5nVXJsIiwiaiIsInByb3h5VXJsIiwiZ2V0VXJsRm9yUHJveHkiLCJzaG91bGQiLCJlcXVhbCIsInNjaGVtZSIsImJhc2UiLCJzZXNzaW9uSWQiLCJ0aHJvdyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUFBLFFBQVEsQ0FBQyxTQUFELEVBQVksWUFBWTtBQUM5QixNQUFJQyxJQUFKO0FBRUEsTUFBSUMsYUFBSjtBQUNBLE1BQUlDLGFBQUo7QUFDQSxNQUFJQyxvQkFBSjtBQUNBLE1BQUlDLGlCQUFKO0FBRUEsUUFBTUMsVUFBVSxHQUFHLFdBQW5CO0FBQ0EsUUFBTUMsVUFBVSxHQUFHLElBQW5CO0FBRUEsUUFBTUMsY0FBYyxHQUFHLDhCQUFnQkYsVUFBaEIsRUFBNEJDLFVBQTVCLENBQXZCO0FBQ0EsUUFBTUUsZ0JBQWdCLEdBQUdELGNBQWMsQ0FBQyxFQUFELEVBQUssUUFBTCxDQUF2Qzs7QUFFQSxXQUFTRSxhQUFULENBQXdCQyxJQUFJLEdBQUcsRUFBL0IsRUFBbUM7QUFDakMsV0FBTyxJQUFJQyxZQUFKLENBQVk7QUFBQ0MsTUFBQUEsTUFBTSxFQUFFQyxrQkFBVDtBQUFvQmIsTUFBQUEsSUFBcEI7QUFBMEIsU0FBR1U7QUFBN0IsS0FBWixDQUFQO0FBQ0Q7O0FBRURJLEVBQUFBLE1BQU0sQ0FBQyxrQkFBa0I7QUFDdkJkLElBQUFBLElBQUksR0FBRyxNQUFNLDJCQUFiO0FBQ0FDLElBQUFBLGFBQWEsR0FBRyw4QkFBZ0JZLGtCQUFoQixFQUEyQmIsSUFBM0IsQ0FBaEI7QUFDQUUsSUFBQUEsYUFBYSxHQUFHRCxhQUFhLENBQUMsRUFBRCxFQUFLLFFBQUwsQ0FBN0I7QUFDQUUsSUFBQUEsb0JBQW9CLEdBQUdGLGFBQWEsQ0FBQ2MsZUFBRCxFQUFJLEVBQUosQ0FBcEM7QUFDQVgsSUFBQUEsaUJBQWlCLEdBQUdILGFBQWEsQ0FBQyxFQUFELEVBQUssU0FBTCxDQUFqQztBQUNELEdBTkssQ0FBTjtBQVFBRixFQUFBQSxRQUFRLENBQUMsb0JBQUQsRUFBdUIsWUFBWTtBQUN6Q2lCLElBQUFBLEVBQUUsQ0FBQyxnQ0FBRCxFQUFtQyxZQUFZO0FBQy9DLFVBQUlDLFdBQVcsR0FBR1QsZ0JBQWxCO0FBQ0EsVUFBSVUsQ0FBQyxHQUFHVCxhQUFhLEVBQXJCO0FBQ0EsVUFBSVUsUUFBUSxHQUFHRCxDQUFDLENBQUNFLGNBQUYsQ0FBaUJILFdBQWpCLENBQWY7QUFDQUUsTUFBQUEsUUFBUSxDQUFDRSxNQUFULENBQWdCQyxLQUFoQixDQUFzQnBCLGFBQXRCO0FBQ0QsS0FMQyxDQUFGO0FBTUFjLElBQUFBLEVBQUUsQ0FBQyw2QkFBRCxFQUFnQyxZQUFZO0FBQzVDLFVBQUlDLFdBQVcsR0FBR1QsZ0JBQWxCO0FBQ0EsVUFBSVUsQ0FBQyxHQUFHVCxhQUFhLENBQUM7QUFBQ2MsUUFBQUEsTUFBTSxFQUFFO0FBQVQsT0FBRCxDQUFyQjtBQUNBLFVBQUlKLFFBQVEsR0FBR0QsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQixDQUFmO0FBQ0FFLE1BQUFBLFFBQVEsQ0FBQ0UsTUFBVCxDQUFnQkMsS0FBaEIsQ0FBc0IsOEJBQWlCLFdBQVVULGtCQUFVLEVBQXJDLEVBQXdDYixJQUF4QyxFQUE4QyxFQUE5QyxFQUFrRCxRQUFsRCxDQUF0QjtBQUNELEtBTEMsQ0FBRjtBQU1BZ0IsSUFBQUEsRUFBRSxDQUFDLDJCQUFELEVBQThCLFlBQVk7QUFDMUMsVUFBSUMsV0FBVyxHQUFHVCxnQkFBbEI7QUFDQSxVQUFJVSxDQUFDLEdBQUdULGFBQWEsQ0FBQztBQUFDZSxRQUFBQSxJQUFJLEVBQUU7QUFBUCxPQUFELENBQXJCO0FBQ0EsVUFBSUwsUUFBUSxHQUFHRCxDQUFDLENBQUNFLGNBQUYsQ0FBaUJILFdBQWpCLENBQWY7QUFDQUUsTUFBQUEsUUFBUSxDQUFDRSxNQUFULENBQWdCQyxLQUFoQixDQUFzQnBCLGFBQXRCO0FBQ0QsS0FMQyxDQUFGO0FBTUFjLElBQUFBLEVBQUUsQ0FBQyxpQ0FBRCxFQUFvQyxZQUFZO0FBQ2hELFVBQUlDLFdBQVcsR0FBR1YsY0FBYyxDQUFDLFFBQUQsRUFBVyxTQUFYLENBQWhDO0FBQ0EsVUFBSVcsQ0FBQyxHQUFHVCxhQUFhLENBQUM7QUFBQ2dCLFFBQUFBLFNBQVMsRUFBRTtBQUFaLE9BQUQsQ0FBckI7QUFDQSxVQUFJTixRQUFRLEdBQUdELENBQUMsQ0FBQ0UsY0FBRixDQUFpQkgsV0FBakIsQ0FBZjtBQUNBRSxNQUFBQSxRQUFRLENBQUNFLE1BQVQsQ0FBZ0JDLEtBQWhCLENBQXNCckIsYUFBYSxDQUFDLFFBQUQsRUFBVyxTQUFYLENBQW5DO0FBQ0QsS0FMQyxDQUFGO0FBTUFlLElBQUFBLEVBQUUsQ0FBQyxtRUFBRCxFQUFzRSxZQUFZO0FBQ2xGLFVBQUlDLFdBQVcsR0FBR1YsY0FBYyxDQUFDLFFBQUQsRUFBVyxTQUFYLENBQWhDO0FBQ0EsVUFBSVcsQ0FBQyxHQUFHVCxhQUFhLEVBQXJCO0FBQ0EsT0FBQyxNQUFNO0FBQUVTLFFBQUFBLENBQUMsQ0FBQ0UsY0FBRixDQUFpQkgsV0FBakI7QUFBZ0MsT0FBekMsRUFBMkNJLE1BQTNDLENBQWtESyxLQUFsRCxDQUF3RCxZQUF4RDtBQUNELEtBSkMsQ0FBRjtBQUtELEdBOUJPLENBQVI7QUFnQ0EzQixFQUFBQSxRQUFRLENBQUMsdUJBQUQsRUFBMEIsWUFBWTtBQUM1Q2lCLElBQUFBLEVBQUUsQ0FBQyxzQkFBRCxFQUF5QixZQUFZO0FBQ3JDLFVBQUlDLFdBQVcsR0FBRyxTQUFsQjtBQUNBLFVBQUlDLENBQUMsR0FBR1QsYUFBYSxFQUFyQjtBQUNBLFVBQUlVLFFBQVEsR0FBR0QsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQixDQUFmO0FBQ0FFLE1BQUFBLFFBQVEsQ0FBQ0UsTUFBVCxDQUFnQkMsS0FBaEIsQ0FBc0JwQixhQUF0QjtBQUNELEtBTEMsQ0FBRjtBQU1BYyxJQUFBQSxFQUFFLENBQUMsdUJBQUQsRUFBMEIsWUFBWTtBQUN0QyxVQUFJQyxXQUFXLEdBQUcsVUFBbEI7QUFDQSxVQUFJQyxDQUFDLEdBQUdULGFBQWEsRUFBckI7QUFDQSxVQUFJVSxRQUFRLEdBQUdELENBQUMsQ0FBQ0UsY0FBRixDQUFpQkgsV0FBakIsQ0FBZjtBQUNBRSxNQUFBQSxRQUFRLENBQUNFLE1BQVQsQ0FBZ0JDLEtBQWhCLENBQXNCbEIsaUJBQXRCO0FBQ0QsS0FMQyxDQUFGO0FBTUFZLElBQUFBLEVBQUUsQ0FBQyx3QkFBRCxFQUEyQixZQUFZO0FBQ3ZDLFVBQUlDLFdBQVcsR0FBRyxXQUFsQjtBQUNBLFVBQUlDLENBQUMsR0FBR1QsYUFBYSxFQUFyQjtBQUNBLFVBQUlVLFFBQVEsR0FBR0QsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQixDQUFmO0FBQ0FFLE1BQUFBLFFBQVEsQ0FBQ0UsTUFBVCxDQUFnQkMsS0FBaEIsQ0FBc0JyQixhQUFhLENBQUMsRUFBRCxFQUFLLFVBQUwsQ0FBbkM7QUFDRCxLQUxDLENBQUY7QUFNQWUsSUFBQUEsRUFBRSxDQUFDLGtEQUFELEVBQXFELFlBQVk7QUFDakUsVUFBSUMsV0FBVyxHQUFHLHlCQUFsQjtBQUNBLFVBQUlDLENBQUMsR0FBR1QsYUFBYSxDQUFDO0FBQUNnQixRQUFBQSxTQUFTLEVBQUU7QUFBWixPQUFELENBQXJCO0FBQ0EsVUFBSU4sUUFBUSxHQUFHRCxDQUFDLENBQUNFLGNBQUYsQ0FBaUJILFdBQWpCLENBQWY7QUFDQUUsTUFBQUEsUUFBUSxDQUFDRSxNQUFULENBQWdCQyxLQUFoQixDQUFzQnJCLGFBQWEsQ0FBQyxRQUFELEVBQVcsU0FBWCxDQUFuQztBQUNELEtBTEMsQ0FBRjtBQU1BZSxJQUFBQSxFQUFFLENBQUMscUVBQUQsRUFBd0UsWUFBWTtBQUNwRixVQUFJQyxXQUFXLEdBQUcseUJBQWxCO0FBQ0EsVUFBSUMsQ0FBQyxHQUFHVCxhQUFhLEVBQXJCO0FBQ0EsT0FBQyxNQUFNO0FBQUVTLFFBQUFBLENBQUMsQ0FBQ0UsY0FBRixDQUFpQkgsV0FBakI7QUFBZ0MsT0FBekMsRUFBMkNJLE1BQTNDLENBQWtESyxLQUFsRCxDQUF3RCxZQUF4RDtBQUNELEtBSkMsQ0FBRjtBQUtBVixJQUFBQSxFQUFFLENBQUMsMENBQUQsRUFBNkMsWUFBWTtBQUN6RCxVQUFJQyxXQUFXLEdBQUcsc0VBQWxCO0FBQ0EsVUFBSUMsQ0FBQyxHQUFHVCxhQUFhLENBQUM7QUFBQ2dCLFFBQUFBLFNBQVMsRUFBRTtBQUFaLE9BQUQsQ0FBckI7QUFDQSxVQUFJTixRQUFRLEdBQUdELENBQUMsQ0FBQ0UsY0FBRixDQUFpQkgsV0FBakIsQ0FBZjtBQUNBRSxNQUFBQSxRQUFRLENBQUNFLE1BQVQsQ0FBZ0JDLEtBQWhCLENBQXNCckIsYUFBYSxDQUFDLEtBQUQsRUFBUSx3QkFBUixDQUFuQztBQUNELEtBTEMsQ0FBRjtBQU1BZSxJQUFBQSxFQUFFLENBQUMsd0RBQUQsRUFBMkQsWUFBWTtBQUN2RSxVQUFJQyxXQUFXLEdBQUcsRUFBbEI7QUFDQSxVQUFJQyxDQUFDLEdBQUdULGFBQWEsRUFBckI7QUFDQSxPQUFDLE1BQU07QUFBRVMsUUFBQUEsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQjtBQUFnQyxPQUF6QyxFQUEyQ0ksTUFBM0MsQ0FBa0RLLEtBQWxELENBQXdELFlBQXhEO0FBQ0FSLE1BQUFBLENBQUMsR0FBR1QsYUFBYSxDQUFDO0FBQUNnQixRQUFBQSxTQUFTLEVBQUU7QUFBWixPQUFELENBQWpCO0FBQ0EsVUFBSU4sUUFBUSxHQUFHRCxDQUFDLENBQUNFLGNBQUYsQ0FBaUJILFdBQWpCLENBQWY7QUFDQUUsTUFBQUEsUUFBUSxDQUFDRSxNQUFULENBQWdCQyxLQUFoQixDQUFzQm5CLG9CQUFvQixDQUFDLEtBQUQsQ0FBMUM7QUFDRCxLQVBDLENBQUY7QUFRQWEsSUFBQUEsRUFBRSxDQUFDLGdEQUFELEVBQW1ELFlBQVk7QUFDL0QsVUFBSUMsV0FBVyxHQUFHLFVBQWxCO0FBQ0EsVUFBSUMsQ0FBQyxHQUFHVCxhQUFhLENBQUM7QUFBQ2dCLFFBQUFBLFNBQVMsRUFBRTtBQUFaLE9BQUQsQ0FBckI7QUFDQSxVQUFJTixRQUFRLEdBQUdELENBQUMsQ0FBQ0UsY0FBRixDQUFpQkgsV0FBakIsQ0FBZjtBQUNBRSxNQUFBQSxRQUFRLENBQUNFLE1BQVQsQ0FBZ0JDLEtBQWhCLENBQXNCckIsYUFBYSxDQUFDLFFBQUQsRUFBVyxTQUFYLENBQW5DO0FBQ0QsS0FMQyxDQUFGO0FBTUFlLElBQUFBLEVBQUUsQ0FBRSw2REFBRixFQUFnRSxZQUFZO0FBQzVFLFVBQUlDLFdBQVcsR0FBRyxpRkFBbEI7QUFDQSxVQUFJQyxDQUFDLEdBQUdULGFBQWEsQ0FBQztBQUFDZ0IsUUFBQUEsU0FBUyxFQUFFO0FBQVosT0FBRCxDQUFyQjtBQUNBLFVBQUlOLFFBQVEsR0FBR0QsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQixDQUFmO0FBQ0FFLE1BQUFBLFFBQVEsQ0FBQ0UsTUFBVCxDQUFnQkMsS0FBaEIsQ0FBc0JyQixhQUFhLENBQUMsUUFBRCxFQUFXLG1DQUFYLENBQW5DO0FBQ0QsS0FMQyxDQUFGO0FBTUFlLElBQUFBLEVBQUUsQ0FBRSw4RkFBRixFQUFpRyxZQUFZO0FBQzdHLFVBQUlDLFdBQVcsR0FBRyxpRkFBbEI7QUFDQSxVQUFJQyxDQUFDLEdBQUdULGFBQWEsQ0FBQztBQUFDZ0IsUUFBQUEsU0FBUyxFQUFFO0FBQVosT0FBRCxDQUFyQjtBQUNBLFVBQUlOLFFBQVEsR0FBR0QsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQixDQUFmO0FBQ0FFLE1BQUFBLFFBQVEsQ0FBQ0UsTUFBVCxDQUFnQkMsS0FBaEIsQ0FBc0JyQixhQUFhLENBQUMsUUFBRCxFQUFXLG1DQUFYLENBQW5DO0FBQ0QsS0FMQyxDQUFGO0FBTUFlLElBQUFBLEVBQUUsQ0FBQyxtRUFBRCxFQUFzRSxZQUFZO0FBQ2xGLFVBQUlDLFdBQVcsR0FBRyxVQUFsQjtBQUNBLFVBQUlDLENBQUMsR0FBR1QsYUFBYSxFQUFyQjtBQUNBLE9BQUMsTUFBTTtBQUFFUyxRQUFBQSxDQUFDLENBQUNFLGNBQUYsQ0FBaUJILFdBQWpCO0FBQWdDLE9BQXpDLEVBQTJDSSxNQUEzQyxDQUFrREssS0FBbEQsQ0FBd0QsWUFBeEQ7QUFDRCxLQUpDLENBQUY7QUFLRCxHQW5FTyxDQUFSO0FBcUVELENBL0hPLENBQVIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bW9jaGFcblxuaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgeyBnZXRUZXN0UG9ydCwgVEVTVF9IT1NULCBjcmVhdGVBcHBpdW1VUkwgfSBmcm9tICcuLi9oZWxwZXJzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmRlc2NyaWJlKCdKV1Byb3h5JywgZnVuY3Rpb24gKCkge1xuICBsZXQgcG9ydDtcblxuICBsZXQgY3JlYXRlVGVzdFVSTDtcbiAgbGV0IHRlc3RTdGF0dXNVUkw7XG4gIGxldCBjcmVhdGVUZXN0U2Vzc2lvblVSTDtcbiAgbGV0IHRlc3ROZXdTZXNzaW9uVVJMO1xuXG4gIGNvbnN0IFBST1hZX0hPU1QgPSAnMTI3LjAuMC4yJztcbiAgY29uc3QgUFJPWFlfUE9SVCA9IDQ3MjM7XG5cbiAgY29uc3QgY3JlYXRlUHJveHlVUkwgPSBjcmVhdGVBcHBpdW1VUkwoUFJPWFlfSE9TVCwgUFJPWFlfUE9SVCk7XG4gIGNvbnN0IFBST1hZX1NUQVRVU19VUkwgPSBjcmVhdGVQcm94eVVSTCgnJywgJ3N0YXR1cycpO1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZUpXUHJveHkgKG9wdHMgPSB7fSkge1xuICAgIHJldHVybiBuZXcgSldQcm94eSh7c2VydmVyOiBURVNUX0hPU1QsIHBvcnQsIC4uLm9wdHN9KTtcbiAgfVxuXG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgcG9ydCA9IGF3YWl0IGdldFRlc3RQb3J0KCk7XG4gICAgY3JlYXRlVGVzdFVSTCA9IGNyZWF0ZUFwcGl1bVVSTChURVNUX0hPU1QsIHBvcnQpO1xuICAgIHRlc3RTdGF0dXNVUkwgPSBjcmVhdGVUZXN0VVJMKCcnLCAnc3RhdHVzJyk7XG4gICAgY3JlYXRlVGVzdFNlc3Npb25VUkwgPSBjcmVhdGVUZXN0VVJMKF8sICcnKTtcbiAgICB0ZXN0TmV3U2Vzc2lvblVSTCA9IGNyZWF0ZVRlc3RVUkwoJycsICdzZXNzaW9uJyk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdwcm94eWluZyBmdWxsIHVybHMnLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCB0cmFuc2xhdGUgaG9zdCBhbmQgcG9ydCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9IFBST1hZX1NUQVRVU19VUkw7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoKTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKHRlc3RTdGF0dXNVUkwpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdHJhbnNsYXRlIHRoZSBzY2hlbWUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSBQUk9YWV9TVEFUVVNfVVJMO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KHtzY2hlbWU6ICdIVFRQUyd9KTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKGNyZWF0ZUFwcGl1bVVSTChgaHR0cHM6Ly8ke1RFU1RfSE9TVH1gLCBwb3J0LCAnJywgJ3N0YXR1cycpKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRyYW5zbGF0ZSB0aGUgYmFzZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9IFBST1hZX1NUQVRVU19VUkw7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoe2Jhc2U6ICcnfSk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbCh0ZXN0U3RhdHVzVVJMKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRyYW5zbGF0ZSB0aGUgc2Vzc2lvbiBpZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9IGNyZWF0ZVByb3h5VVJMKCdmb29iYXInLCAnZWxlbWVudCcpO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KHtzZXNzaW9uSWQ6ICdiYXJiYXonfSk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbChjcmVhdGVUZXN0VVJMKCdiYXJiYXonLCAnZWxlbWVudCcpKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGVycm9yIHdoZW4gdHJhbnNsYXRpbmcgc2Vzc2lvbiBjb21tYW5kcyB3aXRob3V0IHNlc3Npb24gaWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSBjcmVhdGVQcm94eVVSTCgnZm9vYmFyJywgJ2VsZW1lbnQnKTtcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSgpO1xuICAgICAgKCgpID0+IHsgai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7IH0pLnNob3VsZC50aHJvdygnc2Vzc2lvbiBpZCcpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncHJveHlpbmcgcGFydGlhbCB1cmxzJywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgcHJveHkgL3N0YXR1cycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc3RhdHVzJztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSgpO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwodGVzdFN0YXR1c1VSTCk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSAvc2Vzc2lvbicsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbic7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoKTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKHRlc3ROZXdTZXNzaW9uVVJMKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHByb3h5IC9zZXNzaW9ucycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbnMnO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KCk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbChjcmVhdGVUZXN0VVJMKCcnLCAnc2Vzc2lvbnMnKSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSBzZXNzaW9uIGNvbW1hbmRzIGJhc2VkIG9mZiAvc2Vzc2lvbicsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbi9mb29iYXIvZWxlbWVudCc7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoe3Nlc3Npb25JZDogJ2JhcmJheid9KTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKGNyZWF0ZVRlc3RVUkwoJ2JhcmJheicsICdlbGVtZW50JykpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgZXJyb3Igc2Vzc2lvbiBjb21tYW5kcyBiYXNlZCBvZmYgL3Nlc3Npb24gd2l0aG91dCBzZXNzaW9uIGlkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gJy9zZXNzaW9uL2Zvb2Jhci9lbGVtZW50JztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSgpO1xuICAgICAgKCgpID0+IHsgai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7IH0pLnNob3VsZC50aHJvdygnc2Vzc2lvbiBpZCcpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJveHkgc2Vzc2lvbiBjb21tYW5kcyBiYXNlZCBvZmYgJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gJy9zZXNzaW9uLzNkMDAxZGIyLTc5ODctNDJhNy05NzVkLThkNWQ1MzA0MDgzZi90aW1lb3V0cy9pbXBsaWNpdF93YWl0JztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFVSTCgnMTIzJywgJ3RpbWVvdXRzL2ltcGxpY2l0X3dhaXQnKSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSBzZXNzaW9uIGNvbW1hbmRzIGJhc2VkIG9mZiAvc2Vzc2lvbiBhcyBcIlwiJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gJyc7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoKTtcbiAgICAgICgoKSA9PiB7IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpOyB9KS5zaG91bGQudGhyb3coJ3Nlc3Npb24gaWQnKTtcbiAgICAgIGogPSBjcmVhdGVKV1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnfSk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbChjcmVhdGVUZXN0U2Vzc2lvblVSTCgnMTIzJykpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJveHkgc2Vzc2lvbiBjb21tYW5kcyB3aXRob3V0IC9zZXNzaW9uJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gJy9lbGVtZW50JztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSh7c2Vzc2lvbklkOiAnYmFyYmF6J30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFVSTCgnYmFyYmF6JywgJ2VsZW1lbnQnKSk7XG4gICAgfSk7XG4gICAgaXQoYHNob3VsZCBwcm94eSBzZXNzaW9uIGNvbW1hbmRzIHdoZW4gJy9zZXNzaW9uJyBpcyBpbiB0aGUgdXJsYCwgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gJy9zZXNzaW9uLzgyYTliN2RhLWZhYWYtNGExZC04ZWYzLTVlNGZiNTgxMjIwMC9jb29raWUvc2Vzc2lvbi1zb21ldGhpbmctb3Itb3RoZXInO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KHtzZXNzaW9uSWQ6ICdiYXJiYXonfSk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbChjcmVhdGVUZXN0VVJMKCdiYXJiYXonLCAnY29va2llL3Nlc3Npb24tc29tZXRoaW5nLW9yLW90aGVyJykpO1xuICAgIH0pO1xuICAgIGl0KGBzaG91bGQgcHJveHkgc2Vzc2lvbiBjb21tYW5kcyB3aGVuICcvc2Vzc2lvbicgaXMgaW4gdGhlIHVybCBhbmQgbm90IGJhc2Ugb24gdGhlIG9yaWdpbmFsIHVybGAsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbi84MmE5YjdkYS1mYWFmLTRhMWQtOGVmMy01ZTRmYjU4MTIyMDAvY29va2llL3Nlc3Npb24tc29tZXRoaW5nLW9yLW90aGVyJztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSh7c2Vzc2lvbklkOiAnYmFyYmF6J30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFVSTCgnYmFyYmF6JywgJ2Nvb2tpZS9zZXNzaW9uLXNvbWV0aGluZy1vci1vdGhlcicpKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGVycm9yIHNlc3Npb24gY29tbWFuZHMgd2l0aG91dCAvc2Vzc2lvbiB3aXRob3V0IHNlc3Npb24gaWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSAnL2VsZW1lbnQnO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KCk7XG4gICAgICAoKCkgPT4geyBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTsgfSkuc2hvdWxkLnRocm93KCdzZXNzaW9uIGlkJyk7XG4gICAgfSk7XG4gIH0pO1xuXG59KTtcbiJdLCJmaWxlIjoidGVzdC9qc29ud3AtcHJveHkvdXJsLXNwZWNzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
