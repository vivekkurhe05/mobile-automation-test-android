"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lib = require("../../lib");

var _axios = _interopRequireDefault(require("axios"));

var _sinon = _interopRequireDefault(require("sinon"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _helpers = require("../helpers");

describe('server', function () {
  let hwServer;
  let errorStub;
  let port;
  before(async function () {
    port = await (0, _helpers.getTestPort)(true);
    errorStub = _sinon.default.stub(console, 'error');

    function configureRoutes(app) {
      app.get('/', (req, res) => {
        res.header['content-type'] = 'text/html';
        res.status(200).send('Hello World!');
      });
      app.get('/python', (req, res) => {
        res.status(200).send(req.headers['content-type']);
      });
      app.get('/error', () => {
        throw new Error('hahaha');
      });
      app.get('/pause', async (req, res) => {
        res.header['content-type'] = 'text/html';
        await _bluebird.default.delay(1000);
        res.status(200).send('We have waited!');
      });
    }

    hwServer = await (0, _lib.server)({
      routeConfiguringFunction: configureRoutes,
      port
    });
  });
  after(async function () {
    await hwServer.close();
    errorStub.restore();
  });
  it('should start up with our middleware', async function () {
    const {
      data
    } = await _axios.default.get(`http://${_helpers.TEST_HOST}:${port}/`);
    data.should.eql('Hello World!');
  });
  it('should fix broken context type', async function () {
    const {
      data
    } = await (0, _axios.default)({
      url: `http://${_helpers.TEST_HOST}:${port}/python`,
      headers: {
        'user-agent': 'Python',
        'content-type': 'application/x-www-form-urlencoded'
      }
    });
    data.should.eql('application/json; charset=utf-8');
  });
  it('should catch errors in the catchall', async function () {
    await _axios.default.get(`http://${_helpers.TEST_HOST}:${port}/error`).should.be.rejected;
  });
  it('should error if we try to start again on a port that is used', async function () {
    await (0, _lib.server)({
      routeConfiguringFunction() {},

      port
    }).should.be.rejectedWith(/EADDRINUSE/);
  });
  it('should not wait for the server close connections before finishing closing', async function () {
    let bodyPromise = _axios.default.get(`http://${_helpers.TEST_HOST}:${port}/pause`).catch(() => {});

    await _bluebird.default.delay(100);
    let before = Date.now();
    await hwServer.close();
    (Date.now() - before).should.not.be.above(800);
    await bodyPromise;
  });
  it('should error if we try to start on a bad hostname', async function () {
    this.timeout(60000);
    await (0, _lib.server)({
      routeConfiguringFunction: _lodash.default.noop,
      port,
      hostname: 'lolcathost'
    }).should.be.rejectedWith(/ENOTFOUND|EADDRNOTAVAIL|EAI_AGAIN/);
    await (0, _lib.server)({
      routeConfiguringFunction: _lodash.default.noop,
      port,
      hostname: '1.1.1.1'
    }).should.be.rejectedWith(/EADDRNOTAVAIL/);
  });
});
describe('server plugins', function () {
  let hwServer;
  let port;
  before(async function () {
    port = await (0, _helpers.getTestPort)(true);
  });
  afterEach(async function () {
    try {
      await hwServer.close();
    } catch (ign) {}
  });

  function updaterWithGetRoute(route, reply) {
    return async (app, httpServer) => {
      app.get(`/${route}`, (req, res) => {
        res.header['content-type'] = 'text/html';
        res.status(200).send(reply);
      });
      httpServer[`_updated_${route}`] = true;
    };
  }

  it('should allow one or more plugins to update the server', async function () {
    hwServer = await (0, _lib.server)({
      routeConfiguringFunction: _lodash.default.noop,
      port,
      serverUpdaters: [updaterWithGetRoute('plugin1', 'res from plugin1 route'), updaterWithGetRoute('plugin2', 'res from plugin2 route')]
    });
    let {
      data
    } = await _axios.default.get(`http://${_helpers.TEST_HOST}:${port}/plugin1`);
    data.should.eql('res from plugin1 route');
    ({
      data
    } = await _axios.default.get(`http://${_helpers.TEST_HOST}:${port}/plugin2`));
    data.should.eql('res from plugin2 route');
    hwServer._updated_plugin1.should.be.true;
    hwServer._updated_plugin2.should.be.true;
  });
  it('should pass on errors from the plugin updateServer method', async function () {
    await (0, _lib.server)({
      routeConfiguringFunction: _lodash.default.noop,
      port,
      serverUpdaters: [() => {
        throw new Error('ugh');
      }]
    }).should.eventually.be.rejectedWith(/ugh/);
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZXhwcmVzcy9zZXJ2ZXItZTJlLXNwZWNzLmpzIl0sIm5hbWVzIjpbImRlc2NyaWJlIiwiaHdTZXJ2ZXIiLCJlcnJvclN0dWIiLCJwb3J0IiwiYmVmb3JlIiwic2lub24iLCJzdHViIiwiY29uc29sZSIsImNvbmZpZ3VyZVJvdXRlcyIsImFwcCIsImdldCIsInJlcSIsInJlcyIsImhlYWRlciIsInN0YXR1cyIsInNlbmQiLCJoZWFkZXJzIiwiRXJyb3IiLCJCIiwiZGVsYXkiLCJyb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24iLCJhZnRlciIsImNsb3NlIiwicmVzdG9yZSIsIml0IiwiZGF0YSIsImF4aW9zIiwiVEVTVF9IT1NUIiwic2hvdWxkIiwiZXFsIiwidXJsIiwiYmUiLCJyZWplY3RlZCIsInJlamVjdGVkV2l0aCIsImJvZHlQcm9taXNlIiwiY2F0Y2giLCJEYXRlIiwibm93Iiwibm90IiwiYWJvdmUiLCJ0aW1lb3V0IiwiXyIsIm5vb3AiLCJob3N0bmFtZSIsImFmdGVyRWFjaCIsImlnbiIsInVwZGF0ZXJXaXRoR2V0Um91dGUiLCJyb3V0ZSIsInJlcGx5IiwiaHR0cFNlcnZlciIsInNlcnZlclVwZGF0ZXJzIiwiX3VwZGF0ZWRfcGx1Z2luMSIsInRydWUiLCJfdXBkYXRlZF9wbHVnaW4yIiwiZXZlbnR1YWxseSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0FBLFFBQVEsQ0FBQyxRQUFELEVBQVcsWUFBWTtBQUM3QixNQUFJQyxRQUFKO0FBQ0EsTUFBSUMsU0FBSjtBQUNBLE1BQUlDLElBQUo7QUFDQUMsRUFBQUEsTUFBTSxDQUFDLGtCQUFrQjtBQUN2QkQsSUFBQUEsSUFBSSxHQUFHLE1BQU0sMEJBQVksSUFBWixDQUFiO0FBQ0FELElBQUFBLFNBQVMsR0FBR0csZUFBTUMsSUFBTixDQUFXQyxPQUFYLEVBQW9CLE9BQXBCLENBQVo7O0FBQ0EsYUFBU0MsZUFBVCxDQUEwQkMsR0FB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QUFDRyxNQUFMLENBQVlDLEdBQVosQ0FBZ0Isd0JBQWhCO0FBQ0EsS0FBQztBQUFDSixNQUFBQTtBQUFELFFBQVMsTUFBTUMsZUFBTWhCLEdBQU4sQ0FBVyxVQUFTaUIsa0JBQVUsSUFBR3hCLElBQUssVUFBdEMsQ0FBaEI7QUFDQXNCLElBQUFBLElBQUksQ0FBQ0csTUFBTCxDQUFZQyxHQUFaLENBQWdCLHdCQUFoQjtBQUNBNUIsSUFBQUEsUUFBUSxDQUFDa0QsZ0JBQVQsQ0FBMEJ2QixNQUExQixDQUFpQ0csRUFBakMsQ0FBb0NxQixJQUFwQztBQUNBbkQsSUFBQUEsUUFBUSxDQUFDb0QsZ0JBQVQsQ0FBMEJ6QixNQUExQixDQUFpQ0csRUFBakMsQ0FBb0NxQixJQUFwQztBQUNELEdBZkMsQ0FBRjtBQWdCQTVCLEVBQUFBLEVBQUUsQ0FBQywyREFBRCxFQUE4RCxrQkFBa0I7QUFDaEYsVUFBTSxpQkFBTztBQUNYSixNQUFBQSx3QkFBd0IsRUFBRXFCLGdCQUFFQyxJQURqQjtBQUVYdkMsTUFBQUEsSUFGVztBQUdYK0MsTUFBQUEsY0FBYyxFQUFFLENBQUMsTUFBTTtBQUFFLGNBQU0sSUFBSWpDLEtBQUosQ0FBVSxLQUFWLENBQU47QUFBd0IsT0FBakM7QUFITCxLQUFQLEVBSUhXLE1BSkcsQ0FJSTBCLFVBSkosQ0FJZXZCLEVBSmYsQ0FJa0JFLFlBSmxCLENBSStCLEtBSi9CLENBQU47QUFLRCxHQU5DLENBQUY7QUFPRCxDQS9DTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCB7IHNlcnZlciB9IGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1RFU1RfSE9TVCwgZ2V0VGVzdFBvcnR9IGZyb20gJy4uL2hlbHBlcnMnO1xuXG5cbmRlc2NyaWJlKCdzZXJ2ZXInLCBmdW5jdGlvbiAoKSB7XG4gIGxldCBod1NlcnZlcjtcbiAgbGV0IGVycm9yU3R1YjtcbiAgbGV0IHBvcnQ7XG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgcG9ydCA9IGF3YWl0IGdldFRlc3RQb3J0KHRydWUpO1xuICAgIGVycm9yU3R1YiA9IHNpbm9uLnN0dWIoY29uc29sZSwgJ2Vycm9yJyk7XG4gICAgZnVuY3Rpb24gY29uZmlndXJlUm91dGVzIChhcHApIHtcbiAgICAgIGFwcC5nZXQoJy8nLCAocmVxLCByZXMpID0+IHtcbiAgICAgICAgcmVzLmhlYWRlclsnY29udGVudC10eXBlJ10gPSAndGV4dC9odG1sJztcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoJ0hlbGxvIFdvcmxkIScpO1xuICAgICAgfSk7XG4gICAgICBhcHAuZ2V0KCcvcHl0aG9uJywgKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHJlcS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSk7XG4gICAgICB9KTtcbiAgICAgIGFwcC5nZXQoJy9lcnJvcicsICgpID0+IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdoYWhhaGEnKTtcbiAgICAgIH0pO1xuICAgICAgYXBwLmdldCgnL3BhdXNlJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgIHJlcy5oZWFkZXJbJ2NvbnRlbnQtdHlwZSddID0gJ3RleHQvaHRtbCc7XG4gICAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCdXZSBoYXZlIHdhaXRlZCEnKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBod1NlcnZlciA9IGF3YWl0IHNlcnZlcih7XG4gICAgICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb246IGNvbmZpZ3VyZVJvdXRlcyxcbiAgICAgIHBvcnQsXG4gICAgfSk7XG4gIH0pO1xuICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgaHdTZXJ2ZXIuY2xvc2UoKTtcbiAgICBlcnJvclN0dWIucmVzdG9yZSgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHN0YXJ0IHVwIHdpdGggb3VyIG1pZGRsZXdhcmUnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3Qge2RhdGF9ID0gYXdhaXQgYXhpb3MuZ2V0KGBodHRwOi8vJHtURVNUX0hPU1R9OiR7cG9ydH0vYCk7XG4gICAgZGF0YS5zaG91bGQuZXFsKCdIZWxsbyBXb3JsZCEnKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgZml4IGJyb2tlbiBjb250ZXh0IHR5cGUnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3Qge2RhdGF9ID0gYXdhaXQgYXhpb3Moe1xuICAgICAgdXJsOiBgaHR0cDovLyR7VEVTVF9IT1NUfToke3BvcnR9L3B5dGhvbmAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICd1c2VyLWFnZW50JzogJ1B5dGhvbicsXG4gICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJ1xuICAgICAgfVxuICAgIH0pO1xuICAgIGRhdGEuc2hvdWxkLmVxbCgnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBjYXRjaCBlcnJvcnMgaW4gdGhlIGNhdGNoYWxsJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGF4aW9zLmdldChgaHR0cDovLyR7VEVTVF9IT1NUfToke3BvcnR9L2Vycm9yYCkuc2hvdWxkLmJlLnJlamVjdGVkO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBlcnJvciBpZiB3ZSB0cnkgdG8gc3RhcnQgYWdhaW4gb24gYSBwb3J0IHRoYXQgaXMgdXNlZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBhd2FpdCBzZXJ2ZXIoe1xuICAgICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uICgpIHt9LFxuICAgICAgcG9ydCxcbiAgICB9KS5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC9FQUREUklOVVNFLyk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIG5vdCB3YWl0IGZvciB0aGUgc2VydmVyIGNsb3NlIGNvbm5lY3Rpb25zIGJlZm9yZSBmaW5pc2hpbmcgY2xvc2luZycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgYm9keVByb21pc2UgPSBheGlvcy5nZXQoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHtwb3J0fS9wYXVzZWApLmNhdGNoKCgpID0+IHt9KTtcblxuICAgIC8vIHJlbGlucXVpc2ggY29udHJvbCBzbyB0aGF0IHdlIGRvbid0IGNsb3NlIGJlZm9yZSB0aGUgcmVxdWVzdCBpcyByZWNlaXZlZFxuICAgIGF3YWl0IEIuZGVsYXkoMTAwKTtcblxuICAgIGxldCBiZWZvcmUgPSBEYXRlLm5vdygpO1xuICAgIGF3YWl0IGh3U2VydmVyLmNsb3NlKCk7XG4gICAgLy8gZXhwZWN0IHNsaWdodGx5IGxlc3MgdGhhbiB0aGUgcmVxdWVzdCB3YWl0ZWQsIHNpbmNlIHdlIHBhdXNlZCBhYm92ZVxuICAgIChEYXRlLm5vdygpIC0gYmVmb3JlKS5zaG91bGQubm90LmJlLmFib3ZlKDgwMCk7XG5cbiAgICBhd2FpdCBib2R5UHJvbWlzZTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgZXJyb3IgaWYgd2UgdHJ5IHRvIHN0YXJ0IG9uIGEgYmFkIGhvc3RuYW1lJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudGltZW91dCg2MDAwMCk7XG4gICAgYXdhaXQgc2VydmVyKHtcbiAgICAgIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbjogXy5ub29wLFxuICAgICAgcG9ydCxcbiAgICAgIGhvc3RuYW1lOiAnbG9sY2F0aG9zdCcsXG4gICAgfSkuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgvRU5PVEZPVU5EfEVBRERSTk9UQVZBSUx8RUFJX0FHQUlOLyk7XG4gICAgYXdhaXQgc2VydmVyKHtcbiAgICAgIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbjogXy5ub29wLFxuICAgICAgcG9ydCxcbiAgICAgIGhvc3RuYW1lOiAnMS4xLjEuMScsXG4gICAgfSkuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgvRUFERFJOT1RBVkFJTC8pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnc2VydmVyIHBsdWdpbnMnLCBmdW5jdGlvbiAoKSB7XG4gIGxldCBod1NlcnZlcjtcbiAgbGV0IHBvcnQ7XG5cbiAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBwb3J0ID0gYXdhaXQgZ2V0VGVzdFBvcnQodHJ1ZSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGh3U2VydmVyLmNsb3NlKCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9KTtcblxuICBmdW5jdGlvbiB1cGRhdGVyV2l0aEdldFJvdXRlIChyb3V0ZSwgcmVwbHkpIHtcbiAgICByZXR1cm4gYXN5bmMgKGFwcCwgaHR0cFNlcnZlcikgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICAgIGFwcC5nZXQoYC8ke3JvdXRlfWAsIChyZXEsIHJlcykgPT4ge1xuICAgICAgICByZXMuaGVhZGVyWydjb250ZW50LXR5cGUnXSA9ICd0ZXh0L2h0bWwnO1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZChyZXBseSk7XG4gICAgICB9KTtcbiAgICAgIGh0dHBTZXJ2ZXJbYF91cGRhdGVkXyR7cm91dGV9YF0gPSB0cnVlO1xuICAgIH07XG4gIH1cblxuICBpdCgnc2hvdWxkIGFsbG93IG9uZSBvciBtb3JlIHBsdWdpbnMgdG8gdXBkYXRlIHRoZSBzZXJ2ZXInLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgaHdTZXJ2ZXIgPSBhd2FpdCBzZXJ2ZXIoe1xuICAgICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uOiBfLm5vb3AsXG4gICAgICBwb3J0LFxuICAgICAgc2VydmVyVXBkYXRlcnM6IFtcbiAgICAgICAgdXBkYXRlcldpdGhHZXRSb3V0ZSgncGx1Z2luMScsICdyZXMgZnJvbSBwbHVnaW4xIHJvdXRlJyksXG4gICAgICAgIHVwZGF0ZXJXaXRoR2V0Um91dGUoJ3BsdWdpbjInLCAncmVzIGZyb20gcGx1Z2luMiByb3V0ZScpLFxuICAgICAgXVxuICAgIH0pO1xuICAgIGxldCB7ZGF0YX0gPSBhd2FpdCBheGlvcy5nZXQoYGh0dHA6Ly8ke1RFU1RfSE9TVH06JHtwb3J0fS9wbHVnaW4xYCk7XG4gICAgZGF0YS5zaG91bGQuZXFsKCdyZXMgZnJvbSBwbHVnaW4xIHJvdXRlJyk7XG4gICAgKHtkYXRhfSA9IGF3YWl0IGF4aW9zLmdldChgaHR0cDovLyR7VEVTVF9IT1NUfToke3BvcnR9L3BsdWdpbjJgKSk7XG4gICAgZGF0YS5zaG91bGQuZXFsKCdyZXMgZnJvbSBwbHVnaW4yIHJvdXRlJyk7XG4gICAgaHdTZXJ2ZXIuX3VwZGF0ZWRfcGx1Z2luMS5zaG91bGQuYmUudHJ1ZTtcbiAgICBod1NlcnZlci5fdXBkYXRlZF9wbHVnaW4yLnNob3VsZC5iZS50cnVlO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBwYXNzIG9uIGVycm9ycyBmcm9tIHRoZSBwbHVnaW4gdXBkYXRlU2VydmVyIG1ldGhvZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBhd2FpdCBzZXJ2ZXIoe1xuICAgICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uOiBfLm5vb3AsXG4gICAgICBwb3J0LFxuICAgICAgc2VydmVyVXBkYXRlcnM6IFsoKSA9PiB7IHRocm93IG5ldyBFcnJvcigndWdoJyk7fV1cbiAgICB9KS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL3VnaC8pO1xuICB9KTtcbn0pO1xuIl0sImZpbGUiOiJ0ZXN0L2V4cHJlc3Mvc2VydmVyLWUyZS1zcGVjcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
